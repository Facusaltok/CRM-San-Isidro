<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CRM — Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  /* Overlay/z-index por si usás modales */
  #overlay{position:fixed; inset:0; background:rgba(0,0,0,.45); backdrop-filter:blur(2px); z-index:9998; display:none}
  .modal{position:fixed; left:50%; top:6vh; transform:translateX(-50%); z-index:10000; isolation:isolate}
  body.modal-open{overflow:hidden}
  .suggest{z-index:10001}
  /* Tab activo */
  .tab-active{background:#fff; font-weight:600; border-bottom-color:#fff}
  .spinner{width:16px;height:16px;border-radius:50%;border:2px solid #999;border-top-color:transparent;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body class="bg-white text-slate-900">
  <div id="overlay"></div>

  <!-- HEADER -->
  <header class="flex items-center justify-between px-4 py-3 border-b bg-white sticky top-0 z-10">
    <h1 class="text-xl font-bold">CRM San Isidro</h1>
    <div class="flex items-center gap-3">
      <span id="whoami" class="text-slate-500 text-sm"></span>
      <button id="logoutBtn" class="px-3 py-1.5 rounded bg-black text-white">Salir</button>
    </div>
  </header>

  <!-- MENSAJES GLOBALES -->
  <section class="px-4 pt-3">
    <div id="msgBox" class="hidden text-sm px-3 py-2 rounded border"></div>
  </section>

  <!-- TABS -->
  <nav class="px-4 pt-3 border-b bg-white sticky top-[52px] z-10">
    <div class="flex gap-2">
      <button class="tab px-3 py-2 rounded-t border tab-active" data-tab="accesos">Accesos</button>
      <button class="tab px-3 py-2 rounded-t border" data-tab="paqueteria">Paquetería</button>
      <button class="tab px-3 py-2 rounded-t border" data-tab="personas">Personas</button>
      <button class="tab px-3 py-2 rounded-t border" data-tab="contable">Contable</button>
    </div>
  </nav>

  <!-- VIEWS -->
  <main class="p-4 space-y-10">

    <!-- ACCESOS -->
    <section id="view-accesos">
      <div class="flex flex-wrap items-end gap-2 mb-3">
        <div class="grow">
          <label class="block text-sm text-slate-700">Buscar</label>
          <input id="acc-q" class="w-full border rounded-lg px-3 h-11" placeholder="nombre, DNI, vehículo, dominio, motivo…" />
        </div>
        <div>
          <label class="block text-sm text-slate-700">Desde</label>
          <input id="acc-desde" type="date" class="border rounded-lg px-3 h-11" />
        </div>
        <div>
          <label class="block text-sm text-slate-700">Hasta</label>
          <input id="acc-hasta" type="date" class="border rounded-lg px-3 h-11" />
        </div>
        <div class="flex gap-2">
          <button id="acc-filtrar" class="px-3 h-11 rounded-lg bg-black text-white">Buscar</button>
          <button id="acc-limpiar" class="px-3 h-11 rounded-lg border">Limpiar</button>
        </div>
      </div>
      <div class="overflow-auto border rounded-xl bg-white">
        <table class="min-w-[1000px] w-full">
          <thead class="bg-white sticky top-0 border-b">
            <tr class="[&>th]:text-left [&>th]:px-3 [&>th]:py-2">
              <th>Nombre</th><th>DNI</th><th>Vehículo</th><th>Dominio</th><th>Motivo</th>
              <th>F. Ingreso</th><th>H. Ingreso</th><th>F. Salida</th><th>H. Salida</th><th>Creado</th>
            </tr>
          </thead>
          <tbody id="acc-rows" class="[&>tr>td]:px-3 [&>tr>td]:py-2">
            <tr><td colspan="10" class="px-3 py-4 text-slate-500 flex items-center gap-2">
              <span class="spinner"></span> Cargando…
            </td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- PAQUETERÍA -->
    <section id="view-paqueteria" hidden>
      <div class="flex flex-wrap items-end gap-2 mb-3">
        <div class="grow">
          <label class="block text-sm text-slate-700">Buscar</label>
          <input id="paq-q" class="w-full border rounded-lg px-3 h-11" placeholder="receptor, entregado a, descripción, id, empresa…" />
        </div>
        <div>
          <label class="block text-sm text-slate-700">Desde</label>
          <input id="paq-desde" type="date" class="border rounded-lg px-3 h-11" />
        </div>
        <div>
          <label class="block text-sm text-slate-700">Hasta</label>
          <input id="paq-hasta" type="date" class="border rounded-lg px-3 h-11" />
        </div>
        <div class="flex gap-2">
          <button id="paq-filtrar" class="px-3 h-11 rounded-lg bg-black text-white">Buscar</button>
          <button id="paq-limpiar" class="px-3 h-11 rounded-lg border">Limpiar</button>
        </div>
      </div>
      <div class="overflow-auto border rounded-xl bg-white">
        <table class="min-w-[1200px] w-full">
          <thead class="bg-white sticky top-0 border-b">
            <tr class="[&>th]:text-left [&>th]:px-3 [&>th]:py-2">
              <th>Receptor</th><th>Empresa</th><th>Remito</th><th>Estado</th><th>Fecha</th><th>Hora</th>
              <th>Descripción</th><th>ID Nº</th><th>Entregado a</th><th>F. Entrega</th><th>H. Entrega</th><th>Notas</th><th>Creado</th>
            </tr>
          </thead>
          <tbody id="paq-rows" class="[&>tr>td]:px-3 [&>tr>td]:py-2">
            <tr><td colspan="13" class="px-3 py-4 text-slate-500 flex items-center gap-2">
              <span class="spinner"></span> Cargando…
            </td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- PERSONAS -->
    <section id="view-personas" hidden>
      <div class="flex flex-wrap items-end gap-2 mb-3">
        <div class="grow">
          <label class="block text-sm text-slate-700">Buscar</label>
          <input id="per-q" class="w-full border rounded-lg px-3 h-11" placeholder="nombre, DNI, teléfono, email…" />
        </div>
        <div class="flex gap-2">
          <button id="per-filtrar" class="px-3 h-11 rounded-lg bg-black text-white">Buscar</button>
          <button id="per-limpiar" class="px-3 h-11 rounded-lg border">Limpiar</button>
        </div>
      </div>
      <div class="overflow-auto border rounded-xl bg-white">
        <table class="min-w-[800px] w-full">
          <thead class="bg-white sticky top-0 border-b">
            <tr class="[&>th]:text-left [&>th]:px-3 [&>th]:py-2">
              <th>Nombre</th><th>DNI</th><th>Teléfono</th><th>Email</th><th>Creado</th>
            </tr>
          </thead>
          <tbody id="per-rows" class="[&>tr>td]:px-3 [&>tr>td]:py-2">
            <tr><td colspan="5" class="px-3 py-4 text-slate-500 flex items-center gap-2">
              <span class="spinner"></span> Cargando…
            </td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- CONTABLE (genérico si existe) -->
    <section id="view-contable" hidden>
      <div class="mb-3 text-slate-600 text-sm">
        Si existe la tabla <code>contable</code> en Supabase, se mostrará aquí con todas las columnas.
      </div>
      <div class="overflow-auto border rounded-xl bg-white">
        <table class="min-w-[900px] w-full">
          <thead id="con-head" class="bg-white sticky top-0 border-b"></thead>
          <tbody id="con-rows" class="[&>tr>td]:px-3 [&>tr>td]:py-2">
            <tr><td class="px-3 py-4 text-slate-500 flex items-center gap-2">
              <span class="spinner"></span> Cargando…
            </td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

<script>
  // ================== SUPABASE ==================
  const SUPABASE_URL = "https://ecmjxpnpdgmvnxmbciur.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjbWp4cG5wZGdtdm54bWJjaXVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTkyOTcsImV4cCI6MjA3MTY5NTI5N30.ARF49W4hlEbS9KSu2jAeN-W-Q0ORTbHowfVaZv62Cis";
  const sb = window.sb || supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { persistSession: true, autoRefreshToken: true } });

  // ================== UTILS ==================
  const $ = (s, root=document)=>root.querySelector(s);
  const showMsg = (type, text) => {
    const el = $('#msgBox');
    el.classList.remove('hidden');
    el.className = 'text-sm px-3 py-2 rounded border ' + (type==='ok' ? 'bg-green-50 text-green-700 border-green-200' : 'bg-rose-50 text-rose-700 border-rose-200');
    el.textContent = text;
  };
  const esc = s => (s??'').toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));

  function toDate(v){ return v ? new Date(v) : null; }
  function endOfDayStr(v){ return v ? (v + "T23:59:59") : null; }
  function between(dateStr, d1, d2){
    if (!dateStr) return true;
    const t = new Date(dateStr);
    if (d1 && t < d1) return false;
    if (d2 && t > d2) return false;
    return true;
  }

  // ================== SESIÓN ==================
  (async () => {
    try{
      const { data, error } = await sb.auth.getSession();
      if (error) showMsg('err', 'Auth error: ' + (error.message||error));
      if (!data?.session) return location.replace('index.html');
      $('#whoami').textContent = data.session.user?.email || '';
    }catch(e){
      showMsg('err', 'No se pudo verificar la sesión.');
    }
  })();

  // Logout
  $('#logoutBtn').addEventListener('click', async () => {
    try{ await sb.auth.signOut(); }catch(e){}
    location.href = 'index.html';
  });

  // ================== TABS ==================
  const tabs = Array.from(document.querySelectorAll('.tab'));
  const views = {
    accesos: $('#view-accesos'),
    paqueteria: $('#view-paqueteria'),
    personas: $('#view-personas'),
    contable: $('#view-contable'),
  };
  tabs.forEach(b=>{
    b.addEventListener('click', ()=>{
      tabs.forEach(x=> x.classList.toggle('tab-active', x===b));
      Object.values(views).forEach(v=> v.hidden = true);
      const t = b.dataset.tab; views[t].hidden = false;
      if (t==='accesos') loadAccesos();
      if (t==='paqueteria') loadPaqueteria();
      if (t==='personas') loadPersonas();
      if (t==='contable') loadContable();
    });
  });

  // ================== ACCESOS ==================
  async function loadAccesos(){
    const q = $('#acc-q').value.trim().toLowerCase();
    const d1 = toDate($('#acc-desde').value);
    const d2 = endOfDayStr($('#acc-hasta').value) ? new Date(endOfDayStr($('#acc-hasta').value)) : null;

    try{
      const { data, error } = await sb.from('accesos').select('*').order('created_at', { ascending:false }).limit(1000);
      if (error) throw error;
      const rows = (data||[]).filter(r=>{
        const text = [r.nombre,r.dni,r.vehiculo,r.dominio,r.motivo].filter(Boolean).join(' ').toLowerCase();
        const okQ = !q || text.includes(q);
        const fechaRef = r.f_ing || r.created_at;
        const okD = between(fechaRef, d1, d2);
        return okQ && okD;
      }).map(r=>`
        <tr class="border-b last:border-0">
          <td>${esc(r.nombre)}</td>
          <td>${esc(r.dni)}</td>
          <td>${esc(r.vehiculo)}</td>
          <td>${esc(r.dominio)}</td>
          <td>${esc(r.motivo)}</td>
          <td>${esc(r.f_ing)}</td>
          <td>${esc(r.h_ing)}</td>
          <td>${esc(r.f_sal)}</td>
          <td>${esc(r.h_sal)}</td>
          <td>${esc(r.created_at)}</td>
        </tr>
      `).join('') || `<tr><td colspan="10" class="px-3 py-4 text-slate-500">Sin resultados</td></tr>`;
      $('#acc-rows').innerHTML = rows;
    }catch(e){
      $('#acc-rows').innerHTML = `<tr><td colspan="10" class="px-3 py-4 text-rose-600">Error: ${esc(e.message||e)}</td></tr>`;
      showMsg('err', 'Accesos: ' + (e.message||e));
    }
  }
  $('#acc-filtrar').addEventListener('click', loadAccesos);
  $('#acc-limpiar').addEventListener('click', ()=>{ $('#acc-q').value=''; $('#acc-desde').value=''; $('#acc-hasta').value=''; loadAccesos(); });

  // ================== PAQUETERÍA ==================
  async function loadPaqueteria(){
    const q = $('#paq-q').value.trim().toLowerCase();
    const d1 = toDate($('#paq-desde').value);
    const d2 = endOfDayStr($('#paq-hasta').value) ? new Date(endOfDayStr($('#paq-hasta').value)) : null;

    try{
      const { data, error } = await sb.from('paqueteria').select('*').order('created_at', { ascending:false }).limit(1000);
      if (error) throw error;
      const rows = (data||[]).filter(r=>{
        const text = [r.receptor,r.empresa,r.remito,r.estado,r.descripcion,r.id_num,r.entregado_a,r.notas].filter(Boolean).join(' ').toLowerCase();
        const okQ = !q || text.includes(q);
        const fechaRef = r.fecha || r.created_at;
        const okD = between(fechaRef, d1, d2);
        return okQ && okD;
      }).map(r=>`
        <tr class="border-b last:border-0">
          <td>${esc(r.receptor)}</td>
          <td>${esc(r.empresa)}</td>
          <td>${esc(r.remito)}</td>
          <td>${esc(r.estado)}</td>
          <td>${esc(r.fecha)}</td>
          <td>${esc(r.hora)}</td>
          <td>${esc(r.descripcion)}</td>
          <td>${esc(r.id_num)}</td>
          <td>${esc(r.entregado_a)}</td>
          <td>${esc(r.fecha_entrega)}</td>
          <td>${esc(r.hora_entrega)}</td>
          <td>${esc(r.notas)}</td>
          <td>${esc(r.created_at)}</td>
        </tr>
      `).join('') || `<tr><td colspan="13" class="px-3 py-4 text-slate-500">Sin resultados</td></tr>`;
      $('#paq-rows').innerHTML = rows;
    }catch(e){
      $('#paq-rows').innerHTML = `<tr><td colspan="13" class="px-3 py-4 text-rose-600">Error: ${esc(e.message||e)}</td></tr>`;
      showMsg('err', 'Paquetería: ' + (e.message||e));
    }
  }
  $('#paq-filtrar').addEventListener('click', loadPaqueteria);
  $('#paq-limpiar').addEventListener('click', ()=>{ $('#paq-q').value=''; $('#paq-desde').value=''; $('#paq-hasta').value=''; loadPaqueteria(); });

  // ================== PERSONAS ==================
  async function loadPersonas(){
    const q = $('#per-q').value.trim().toLowerCase();
    try{
      const { data, error } = await sb.from('personas').select('*').order('created_at', { ascending:false }).limit(1000);
      if (error) throw error;
      const rows = (data||[]).filter(r=>{
        const text = [r.nombre,r.dni,r.telefono,r.email].filter(Boolean).join(' ').toLowerCase();
        return !q || text.includes(q);
      }).map(r=>`
        <tr class="border-b last:border-0">
          <td>${esc(r.nombre)}</td>
          <td>${esc(r.dni)}</td>
          <td>${esc(r.telefono)}</td>
          <td>${esc(r.email)}</td>
          <td>${esc(r.created_at)}</td>
        </tr>
      `).join('') || `<tr><td colspan="5" class="px-3 py-4 text-slate-500">Sin resultados</td></tr>`;
      $('#per-rows').innerHTML = rows;
    }catch(e){
      $('#per-rows').innerHTML = `<tr><td colspan="5" class="px-3 py-4 text-rose-600">Error: ${esc(e.message||e)}</td></tr>`;
      showMsg('err', 'Personas: ' + (e.message||e));
    }
  }
  $('#per-filtrar').addEventListener('click', loadPersonas);
  $('#per-limpiar').addEventListener('click', ()=>{ $('#per-q').value=''; loadPersonas(); });

  // ================== CONTABLE (si existe) ==================
  async function loadContable(){
    const head = $('#con-head'); const body = $('#con-rows');
    try{
      const { data, error } = await sb.from('contable').select('*').order('created_at', { ascending:false }).limit(1000);
      if (error) throw error;
      const cols = data?.length ? Object.keys(data[0]) : [];
      head.innerHTML = `<tr class="[&>th]:text-left [&>th]:px-3 [&>th]:py-2">${cols.map(c=>`<th>${esc(c)}</th>`).join('')}</tr>`;
      body.innerHTML = (data||[]).map(r=>`
        <tr class="border-b last:border-0">
          ${cols.map(c=>`<td>${esc(r[c])}</td>`).join('')}
        </tr>
      `).join('') || `<tr><td class="px-3 py-4 text-slate-500">Sin datos</td></tr>`;
    }catch(e){
      head.innerHTML=''; body.innerHTML = `<tr><td class="px-3 py-4 text-rose-600">Error: ${esc(e.message||e)}</td></tr>`;
      showMsg('err', 'Contable: ' + (e.message||e));
    }
  }

  // ================== INIT ==================
  // Arranca en Accesos
  loadAccesos();
</script>
</body>
</html>
