<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CRM — Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{ color-scheme: light; }
  body{ background:#fff; position:relative; overflow-x:hidden; }
  .gold-glow{ pointer-events:none; position:fixed; inset:-20% -20% auto auto; width:70vmax; height:70vmax; border-radius:50%;
    background: radial-gradient(closest-side, rgba(245,158,11,.12), transparent 70%); animation: floatGlow 16s ease-in-out infinite alternate; filter: blur(12px); z-index:0; }
  .gold-ribbon{ pointer-events:none; position:fixed; left:-10%; top:40%; width:120vmax; height:200px;
    background: linear-gradient(90deg, transparent, rgba(245,158,11,.08), transparent); transform: rotate(-6deg); animation: shimmer 10s linear infinite; z-index:0; }
  @keyframes floatGlow{ from{ transform: translate(0,0) scale(1) } to{ transform: translate(-6%,4%) scale(1.05) } }
  @keyframes shimmer{ 0%{ background-position:-200% 0 } 100%{ background-position:200% 0 } }
  .app-layer{ position:relative; z-index:1; }
  .tab{padding:.5rem .9rem;border-radius:.7rem;border:1px solid rgb(203 213 225);background:#f8fafc;color:#0f172a}
  .tab.active{background:#f59e0b;color:#111827;border-color:#f59e0b}
  .chip{border:1px solid rgb(203 213 225);border-radius:999px;padding:.15rem .6rem;font-size:.75rem}
  .kpi{border:1px solid rgb(226 232 240);border-radius:14px;background:#fff;padding:12px}
  .table-wrap{max-height:65vh; overflow:auto;}
  .modal-body{max-height:75vh; overflow:auto;}
</style>
</head>

<body class="min-h-screen text-slate-800">
  <div class="gold-glow"></div>
  <div class="gold-ribbon"></div>

  <div class="app-layer">
    <header class="max-w-6xl mx-auto px-4 py-6 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-xl bg-amber-400 text-slate-900 font-extrabold flex items-center justify-center">CRM</div>
        <div>
          <h1 class="text-2xl font-semibold leading-tight">San Isidro</h1>
          <p class="text-xs text-slate-500">Panel</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-50">Actualizar</button>
        <button id="exportBtn"  class="px-3 py-2 rounded-lg bg-amber-400 text-slate-900 font-medium">Exportar PDF</button>
        <button id="logoutBtn"  class="px-3 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-50">Salir</button>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 pb-24">
      <nav class="flex gap-2 mb-4">
        <button data-tab="accesos"    class="tab active">Accesos</button>
        <button data-tab="paqueteria" class="tab">Paquetería</button>
        <button data-tab="contable"   class="tab">Contable</button>
        <button data-tab="agenda"     class="tab">Agenda</button>
        <button data-tab="parte"      class="tab">Parte diario</button>
      </nav>

      <section class="rounded-2xl bg-white border border-slate-200 shadow-2xl p-4">
        <div class="flex items-end gap-3 flex-wrap">
          <div>
            <label class="block text-xs mb-1 text-slate-600">Desde</label>
            <input id="fDesde" type="date" class="px-3 py-2 rounded-lg bg-white border border-slate-300 outline-none focus:ring focus:ring-amber-300">
          </div>
          <div>
            <label class="block text-xs mb-1 text-slate-600">Hasta</label>
            <input id="fHasta" type="date" class="px-3 py-2 rounded-lg bg-white border border-slate-300 outline-none focus:ring focus:ring-amber-300">
          </div>

          <!-- Filtro asignado solo para Agenda -->
          <div id="wrapAsignado" class="hidden">
            <label class="block text-xs mb-1 text-slate-600">Asignado a</label>
            <div class="flex gap-1">
              <select id="asignado" class="px-3 py-2 rounded-lg bg-white border border-slate-300 outline-none focus:ring focus:ring-amber-300">
                <option>Todos</option><option>Amalia</option><option>Valentino</option><option>Otros</option>
              </select>
              <button class="chip" data-quick="Amalia">Amalia</button>
              <button class="chip" data-quick="Valentino">Valentino</button>
              <button class="chip" data-quick="Otros">Otros</button>
            </div>
          </div>

          <div class="flex-1">
            <label class="block text-xs mb-1 text-slate-600">Buscar</label>
            <input id="q" type="text" placeholder="Texto libre"
              class="w-full px-3 py-2 rounded-lg bg-white border border-slate-300 outline-none focus:ring focus:ring-amber-300">
          </div>
          <button id="newBtn"   class="px-3 py-2 rounded-lg bg-amber-400 text-slate-900 font-medium">+ Nuevo</button>
          <button id="filterBtn" class="px-3 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-50">Filtrar</button>
          <button id="clearBtn"  class="px-3 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-50">Limpiar</button>
        </div>

        <!-- KPIs contables -->
        <div id="contableKpis" class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4 hidden">
          <div class="kpi"><div class="text-xs text-slate-500">Ingresos</div><div id="k_ing" class="text-lg font-semibold">—</div></div>
          <div class="kpi"><div class="text-xs text-slate-500">Egresos</div><div id="k_egr" class="text-lg font-semibold">—</div></div>
          <div class="kpi"><div class="text-xs text-slate-500">Saldo</div><div id="k_saldo" class="text-lg font-semibold">—</div></div>
        </div>

        <div class="table-wrap mt-4">
          <table class="min-w-full">
            <thead id="thead" class="text-sm text-slate-600 bg-slate-50"></thead>
            <tbody id="rows"  class="text-sm"></tbody>
          </table>
          <p id="empty" class="text-center text-slate-500 py-6 hidden">Sin registros</p>
          <p id="err"   class="text-center text-red-500 py-2"></p>
        </div>
      </section>
    </main>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center p-4">
      <div class="w-full max-w-3xl rounded-2xl bg-white border border-slate-200 p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 id="modalTitle" class="text-lg font-semibold">Nuevo</h3>
          <button id="closeModal" class="px-2 py-1 rounded-lg bg-white border border-slate-300 hover:bg-slate-50">Cerrar</button>
        </div>
        <form id="form" class="grid md:grid-cols-2 gap-3 modal-body"></form>
        <div class="mt-4 flex justify-between items-center gap-2">
          <div id="hint" class="text-xs text-slate-500"></div>
          <div class="flex gap-2">
            <button id="saveBtn" class="px-3 py-2 rounded-lg bg-amber-400 text-slate-900 font-medium">Guardar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const sb = supabase.createClient(
    "https://ecmjxpnpdgmvnxmbciur.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjbWp4cG5wZGdtdm54bWJjaXVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTkyOTcsImV4cCI6MjA3MTY5NTI5N30.ARF49W4hlEbS9KSu2jAeN-W-Q0ORTbHowfVaZv62Cis"
  );

  // *** AJUSTADO A TUS TABLAS ORIGINALES ***
  const tabs = {
    accesos: {
      table: "accesos",
      head: ["Fecha","Persona","Tipo","Obs."],
      fields: [
        {k:"persona", l:"Persona", t:"text", r:true},
        {k:"tipo",    l:"Tipo", t:"select", p:["entrada","salida"], r:true},
        {k:"fecha",   l:"Fecha", t:"datetime-local"},
        {k:"observaciones", l:"Observaciones", t:"textarea"},
      ],
      row: r => [fmtDate(r.fecha), r.persona || r.persona_id || "-", r.tipo, r.observaciones || ""],
      searchKeys: ["persona","tipo","observaciones"]
    },
    paqueteria: {
      table: "paqueteria",
      head: ["Fecha","Proveedor","Tracking","Estado","Obs."],
      fields: [
        {k:"proveedor", l:"Proveedor", t:"text", r:true},
        {k:"tracking",  l:"Tracking", t:"text"},
        {k:"estado",    l:"Estado", t:"select", p:["pendiente","en_camino","entregado","incidencia"]},
        {k:"fecha",     l:"Fecha", t:"datetime-local"},
        {k:"observaciones", l:"Observaciones", t:"textarea"},
      ],
      row: r => [fmtDate(r.fecha), r.proveedor, r.tracking, r.estado, r.observaciones || ""],
      searchKeys: ["proveedor","tracking","estado","observaciones"]
    },
    contable: {
      table: "movimientos",        // si tu tabla contable se llama distinto, cambialo aquí
      head: ["Fecha","Tipo","Concepto","Monto"],
      fields: [
        {k:"fecha",    l:"Fecha", t:"date", r:true},
        {k:"tipo",     l:"Tipo",  t:"select", p:["Ingreso","Egreso"], r:true},
        {k:"concepto", l:"Concepto", t:"text", r:true},
        {k:"monto",    l:"Monto (ARS)", t:"number", r:true},
      ],
      row: r => [r.fecha, r.tipo, r.concepto, formatMoney(r.monto)],
      searchKeys: ["tipo","concepto"]
    },
    agenda: {
      table: "agenda",             // *** sin campos de autos ***
      head: ["Asignado","Cliente","Servicio","Fecha","Hora","Estado","Notas"],
      fields: [
        {k:"asignado_a", l:"Asignado a", t:"select", p:["Amalia","Valentino","Otros"], r:true},
        {k:"cliente",    l:"Cliente", t:"text", r:true},
        {k:"servicio",   l:"Servicio", t:"text", r:true},
        {k:"fecha",      l:"Fecha", t:"date", r:true},
        {k:"hora",       l:"Hora",  t:"time"},
        {k:"estado",     l:"Estado", t:"select", p:["pendiente","confirmado","completado","cancelado"], r:true},
        {k:"notas",      l:"Notas", t:"textarea"},
      ],
      row: r => [r.asignado_a, r.cliente, r.servicio, r.fecha, r.hora || "--:--", r.estado, r.notas || ""],
      searchKeys: ["asignado_a","cliente","servicio","estado","notas"]
    },
    parte: {
      table: "parte_diario",
      head: ["Fecha","Inicio","Fin","Caja chica","Resumen"],
      fields: [
        {k:"fecha",       l:"Fecha", t:"date", r:true},
        {k:"hora_inicio", l:"Hora inicio", t:"time"},
        {k:"hora_fin",    l:"Hora fin", t:"time"},
        {k:"caja_chica",  l:"Caja chica (ARS)", t:"number"},
        {k:"agenda_texto",l:"Agenda (texto)", t:"textarea"},
        {k:"otros",       l:"Otros (texto)", t:"textarea"},
      ],
      row: r => [r.fecha, r.hora_inicio || "--:--", r.hora_fin || "--:--", formatMoney(r.caja_chica), (r.agenda_texto || r.otros || "").toString().slice(0,60)+"…"],
      searchKeys: ["agenda_texto","otros"]
    }
  };

  // Estado general
  let current = "accesos";
  const thead = byId("thead"), rows = byId("rows"), empty = byId("empty"), errEl = byId("err");
  const wrapAsignado = byId("wrapAsignado"), selAsignado = byId("asignado");
  const contKpis = byId("contableKpis");

  (async () => {
    const { data } = await sb.auth.getSession();
    if (!data?.session) { location.replace("./index.html"); return; }
    const today = new Date().toISOString().slice(0,10);
    byId("fDesde").value = today; byId("fHasta").value = today;
    buildHead(); toggleAgendaFilter(); await load();
  })();

  // Navegación
  document.querySelectorAll("[data-tab]").forEach(b=>{
    b.addEventListener("click", async ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      current = b.dataset.tab;
      buildHead(); toggleAgendaFilter(); await load();
    });
  });

  // Atajos Agenda
  document.querySelectorAll('[data-quick]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ selAsignado.value = btn.dataset.quick; load(); });
  });

  // Botones
  byId("logoutBtn").addEventListener("click", async ()=>{ await sb.auth.signOut(); location.replace("./index.html"); });
  byId("refreshBtn").addEventListener("click", load);
  byId("filterBtn").addEventListener("click", load);
  byId("exportBtn").addEventListener("click", exportPDF);
  byId("clearBtn").addEventListener("click", ()=>{ byId("fDesde").value=""; byId("fHasta").value=""; selAsignado.value="Todos"; byId("q").value=""; load(); });

  // Modal
  const modal = byId("modal"), form = byId("form"), hint = byId("hint");
  byId("newBtn").addEventListener("click", openModal);
  byId("closeModal").addEventListener("click", ()=>modal.classList.add("hidden"));
  byId("saveBtn").addEventListener("click", save);

  function toggleAgendaFilter(){ wrapAsignado.classList.toggle("hidden", current!=="agenda"); contKpis.classList.toggle("hidden", current!=="contable"); }
  function buildHead(){ thead.innerHTML = `<tr class="border-b border-slate-200">${tabs[current].head.map(h=>`<th class="text-left py-2 pr-4">${h}</th>`).join("")}</tr>`; }
  function filterLocal(list){
    const q = byId("q").value.trim().toLowerCase(); if (!q) return list;
    const keys = tabs[current].searchKeys||[]; return list.filter(r => keys.some(k => (`${r[k]||""}`).toLowerCase().includes(q)));
  }

  async function load(){
    rows.innerHTML=""; empty.classList.add("hidden"); errEl.textContent="";
    const desde = byId("fDesde").value, hasta = byId("fHasta").value;
    let q = sb.from(tabs[current].table).select("*").order("created_at",{ascending:false});

    const dateCol = current==="accesos" ? "fecha" : current==="paqueteria" ? "fecha" : current==="contable" ? "fecha" : current==="agenda" ? "fecha" : "fecha";
    if (desde) q = q.gte(dateCol, desde);
    if (hasta) q = q.lte(dateCol, hasta);

    if (current==="agenda" && selAsignado.value!=="Todos") q = q.eq("asignado_a", selAsignado.value);

    const { data, error } = await q;
    if (error){ errEl.textContent = error.message; return; }
    const list = filterLocal(data||[]);
    if (!list.length){ empty.classList.remove("hidden"); if(current==="contable") updateKpis([]); return; }

    // Pintar
    for (const r of list){
      const t = tabs[current].row(r).map(v=>`<td class="py-2 pr-4 border-b border-slate-100 align-top">${esc(v??"")}</td>`).join("");
      rows.insertAdjacentHTML("beforeend", `<tr>${t}</tr>`);
    }
    if (current==="contable") updateKpis(list);
  }

  function updateKpis(list){
    let ing=0,egr=0; for(const r of list){ if(r.tipo==="Ingreso") ing+=Number(r.monto||0); if(r.tipo==="Egreso") egr+=Number(r.monto||0); }
    byId('k_ing').textContent   = formatMoney(ing);
    byId('k_egr').textContent   = formatMoney(egr);
    byId('k_saldo').textContent = formatMoney(ing-egr);
  }

  function openModal(){
    byId("modalTitle").textContent = `Nuevo — ${capitalize(current)}`;
    form.innerHTML=""; hint.innerHTML="";
    for (const f of tabs[current].fields) form.insertAdjacentHTML("beforeend", fieldHTML(f));
    if (current==="parte"){ hint.textContent = 'Podés pegar aquí la agenda del día. El formulario es desplazable.'; prefillAgendaToday(); byId("f_fecha").value = new Date().toISOString().slice(0,10); }
    modal.classList.remove("hidden");
  }

  async function prefillAgendaToday(){
    const h = new Date(); const today = h.toISOString().slice(0,10);
    const { data, error } = await sb.from('agenda').select('asignado_a,cliente,servicio,hora,estado').eq('fecha', today).order('hora',{ascending:true});
    if (error) return;
    const g = {Amalia:[],Valentino:[],Otros:[]};
    for(const r of (data||[])){ (g[r.asignado_a]||g.Otros).push(r); }
    const fmt = (arr)=>arr.map(x=>`• ${x.hora||'--:--'} ${x.cliente} — ${x.servicio} (${x.estado||'pendiente'})`).join('\n')||'—';
    const text = ['AMALIA',fmt(g.Amalia),'','VALENTINO',fmt(g.Valentino),'','OTROS',fmt(g.Otros)].join('\n');
    const ta = byId('f_agenda_texto'); if (ta) ta.value = text;
  }

  function fieldHTML(f){
    const base = `class="w-full px-3 py-2 rounded-lg bg-white border border-slate-300 outline-none focus:ring focus:ring-amber-300"`;
    if (f.t==="select")   return `<div><label class="block text-xs mb-1 text-slate-600">${f.l}${f.r?" *":""}</label><select id="f_${f.k}" ${base}>${(f.p||[]).map(x=>`<option>${x}</option>`).join("")}</select></div>`;
    if (f.t==="textarea") return `<div class="md:col-span-2"><label class="block text-xs mb-1 text-slate-600">${f.l}${f.r?" *":""}</label><textarea id="f_${f.k}" rows="4" ${base}></textarea></div>`;
    return `<div><label class="block text-xs mb-1 text-slate-600">${f.l}${f.r?" *":""}</label><input id="f_${f.k}" type="${f.t||'text'}" ${base}></div>`;
  }

  async function save(ev){
    ev?.preventDefault?.();
    const { data: u } = await sb.auth.getUser(); const uid = u?.user?.id; if (!uid){ alert("Sesión expirada"); return; }
    const def = tabs[current]; let payload = { user_id: uid };
    for (const f of def.fields){
      const el = byId(`f_${f.k}`); let v = el ? el.value : null;
      if (f.t==="number" && v!=="") v = Number(v); if (f.r && (v===null || v==="")){ alert(`Completá: ${f.l}`); return; }
      if (v==="") v = null; payload[f.k] = v;
    }
    const { error } = await sb.from(def.table).insert(payload);
    if (error){ alert("Guardar: " + error.message); return; }
    byId("modal").classList.add("hidden");
    await load();
  }

  // Exportar PDF
  function exportPDF(){
    const map = {accesos:"Accesos", paqueteria:"Paquetería", contable:"Contable", agenda:"Agenda", parte:"Parte Diario"};
    const head = [...document.querySelectorAll('#thead th')].map(th => th.textContent.trim());
    const body = [...document.querySelectorAll('#rows tr')].map(tr => [...tr.children].map(td => td.innerText));
    if (!body.length){ alert("No hay datos para exportar."); return; }
    const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit:'pt', format:'a4' });
    const title = `CRM — ${map[current]}`; doc.setFontSize(14); doc.text(title, 40, 40);
    doc.autoTable({ startY:60, head:[head], body, styles:{ fontSize:9, cellPadding:4 }, headStyles:{ fillColor:[245,158,11] }, theme:'striped' });
    doc.save(`${map[current]}_${new Date().toISOString().slice(0,10)}.pdf`);
  }

  // Helpers
  function byId(id){ return document.getElementById(id); }
  function esc(v){ return (""+v).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  function formatMoney(n){ const x = Number(n||0); return x.toLocaleString("es-AR",{style:"currency",currency:"ARS"}); }
  function fmtDate(v){ if(!v) return ""; try{ return new Date(v).toLocaleString(); } catch{ return v; } }
  function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

  // Eventos varios
  document.getElementById("logoutBtn").addEventListener("click", async ()=>{ await sb.auth.signOut(); location.replace("./index.html"); });
</script>
</body>
</html>
