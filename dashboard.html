<!DOCTYPE html>
<html lang="es">
<head>
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CRM — Dashboard Premium</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{ 
    color-scheme: light; 
    --gold-50:#fffbf0;--gold-100:#fef3c7;--gold-200:#fde68a;--gold-300:#fcd34d;--gold-400:#fbbf24;--gold-500:#f59e0b;--gold-600:#d97706;--gold-700:#b45309;--gold-800:#92400e;--gold-900:#78350f;
    --primary:#1e293b;--primary-dark:#0f172a;--secondary:#334155;--light:#f8fafc;--dark:#0f172a;--gray:#64748b;--white:#ffffff;
  }
  *{box-sizing:border-box}
  body{background:linear-gradient(135deg,var(--light),var(--gold-50));font-family:'Inter',system-ui,sans-serif;color:var(--primary);min-height:100vh}
  header{background:linear-gradient(135deg,var(--primary-dark),var(--primary));border-bottom:1px solid rgba(251,191,36,.2);box-shadow:0 25px 50px -12px rgba(0,0,0,.25)}
  .main-container{max-width:1200px;margin:0 auto;padding:0 16px}
  .tab{padding:1rem 1.25rem;border-radius:16px 16px 0 0;background:rgba(255,255,255,.1);color:black;font-weight:600;border:1px solid transparent}
  .tab.active{background:linear-gradient(135deg,var(--gold-500),var(--gold-600));color:black;box-shadow:0 15px 25px -5px rgba(251,191,36,.5);border-color:var(--gold-700)}
  .filters-container,.kpi,.table-card{background:#fff;border:1px solid var(--gold-100);border-radius:24px;box-shadow:0 10px 20px rgba(0,0,0,.06)}
  .label{font-size:.8rem;color:#64748b;font-weight:700;letter-spacing:.6px;margin-bottom:.25rem;text-transform:uppercase}
  .input{width:100%;padding:.85rem 1rem;border:1px solid var(--gold-200);border-radius:12px}
  .btn{padding:.8rem 1.25rem;border-radius:12px;border:1px solid var(--gold-200);background:#fff;font-weight:600;display:inline-flex;gap:.5rem;align-items:center}
  .btn-gold{background:linear-gradient(135deg,var(--gold-500),var(--gold-600));color:#fff;border-color:var(--gold-700)}
  .badge{border:1px solid var(--gold-200);border-radius:999px;padding:.25rem .6rem;font-size:.75rem}
  .table-wrap{max-height:65vh;overflow:auto;border-radius:20px;border:1px solid var(--gold-100)}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead.sticky-head th{position:sticky;top:0;background:linear-gradient(135deg,var(--gold-50),var(--gold-100));z-index:1}
  th{padding:1rem 1.25rem;text-align:left;border-bottom:1px solid var(--gold-200);font-size:.75rem;letter-spacing:.8px;text-transform:uppercase}
  td{padding:1rem 1.25rem;border-bottom:1px solid var(--gold-100);vertical-align:top}
  tr:hover td{background:rgba(251,191,36,.08)}
  .status-badge{display:inline-flex;align-items:center;padding:.35rem .8rem;border-radius:999px;font-size:.75rem;font-weight:700;border:1px solid transparent}
  .status-success{background:rgba(16,185,129,.1); color:#10b981; border-color:rgba(16,185,129,.2)}
  .status-warning{background:rgba(245,158,11,.1); color:#f59e0b; border-color:rgba(245,158,11,.2)}
  .status-info{background:rgba(59,130,246,.1); color:#3b82f6; border-color:rgba(59,130,246,.2)}
  .hidden{display:none}
</style>
</head>
<body>
  <header class="py-6">
    <div class="main-container flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-amber-400 to-amber-600 text-white flex items-center justify-center font-black">CRM</div>
        <div>
          <h1 class="text-3xl text-white font-bold">San Isidro</h1>
          <p class="text-amber-100 text-sm">Panel de Control Premium</p>
        </div>
      </div>
      <div class="flex gap-2">
        <button id="refreshBtn" class="btn"><i class="fas fa-sync-alt"></i><span>Actualizar</span></button>
        <button id="logoutBtn" class="btn"><i class="fas fa-sign-out-alt"></i><span>Salir</span></button>
      </div>
    </div>
  </header>

  <main class="py-8">
    <div class="main-container">
      <nav class="flex gap-3 mb-6 overflow-x-auto">
        <button class="tab active" data-tab="accesos"><i class="fas fa-door-open mr-2"></i>Accesos</button>
        <button class="tab" data-tab="paqueteria"><i class="fas fa-box mr-2"></i>Paquetería</button>
        <button class="tab" data-tab="contable"><i class="fas fa-calculator mr-2"></i>Contable</button>
        <button class="tab" data-tab="parte"><i class="fas fa-clipboard-list mr-2"></i>Parte diario</button>
      </nav>

      <div class="filters-container p-4 mb-6">
        <div class="flex flex-wrap items-end gap-4">
          <div>
            <div class="label">Desde</div>
            <input id="fDesde" type="date" class="input w-44">
          </div>
          <div>
            <div class="label">Hasta</div>
            <input id="fHasta" type="date" class="input w-44">
          </div>
          <div class="flex-1 min-w-[260px]">
            <div class="label">Buscar</div>
            <div class="relative">
              <input id="q" type="text" class="input pr-10" placeholder="Texto libre (nombre, DNI, etc.)">
              <i class="fas fa-search absolute right-3 top-3.5 text-slate-400"></i>
            </div>
            <div id="extraHint" class="text-xs text-slate-500 mt-1"></div>
          </div>
          <div class="flex gap-2">
            <button id="newBtn" class="btn btn-gold"><i class="fas fa-plus"></i><span>Nuevo</span></button>
            <button id="filterBtn" class="btn"><i class="fas fa-search"></i><span>Buscar</span></button>
            <button id="clearBtn" class="btn"><i class="fas fa-eraser"></i><span>Limpiar</span></button>
            <button id="showAllBtn" class="btn"><i class="fas fa-list"></i><span>Mostrar todo</span></button>
          </div>
        </div>
      </div>

      <div id="contableKpis" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 hidden">
        <div class="kpi p-4">
          <div class="text-sm text-slate-500 font-bold uppercase tracking-wide mb-1">Ingresos</div>
          <div id="k_ing" class="text-3xl font-extrabold bg-gradient-to-br from-amber-600 to-amber-500 bg-clip-text text-transparent">—</div>
        </div>
        <div class="kpi p-4">
          <div class="text-sm text-slate-500 font-bold uppercase tracking-wide mb-1">Egresos</div>
          <div id="k_egr" class="text-3xl font-extrabold bg-gradient-to-br from-amber-600 to-amber-500 bg-clip-text text-transparent">—</div>
        </div>
        <div class="kpi p-4">
          <div class="text-sm text-slate-500 font-bold uppercase tracking-wide mb-1">Saldo</div>
          <div id="k_saldo" class="text-3xl font-extrabold bg-gradient-to-br from-amber-600 to-amber-500 bg-clip-text text-transparent">—</div>
        </div>
      </div>

      <div id="accesosKpi" class="kpi p-4 mb-6 hidden">
        <div class="flex items-center justify-between gap-4">
          <div>
            <div class="text-sm text-slate-500 font-bold uppercase tracking-wide mb-1">Total horas (lista filtrada)</div>
            <div id="k_horas" class="text-3xl font-extrabold bg-gradient-to-br from-amber-600 to-amber-500 bg-clip-text text-transparent">—</div>
          </div>
          <span id="k_horas_badge" class="badge">Accesos</span>
        </div>
      </div>

      <div id="paqueteriaSubTabs" class="flex gap-2 mb-4 hidden">
        <button id="tabPendientes" class="btn"><i class="fas fa-clock"></i><span>Pendientes</span> <span id="pendientesCount" class="badge ml-2">0</span></button>
        <button id="tabEntregados" class="btn"><i class="fas fa-check-circle"></i><span>Entregados</span> <span id="entregadosCount" class="badge ml-2">0</span></button>
      </div>

      <div class="table-card">
        <div class="p-4 border-b border-amber-100 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center text-xl">
              <i id="tableIcon" class="fas fa-door-open"></i>
            </div>
            <div class="text-xl font-bold" id="tableTitle">Accesos</div>
          </div>
          <span id="recordCount" class="text-sm text-slate-500">— registros</span>
        </div>
        <div class="table-wrap">
          <table>
            <thead id="thead" class="sticky-head"></thead>
            <tbody id="rows"></tbody>
          </table>
          <p id="empty" class="text-center text-slate-500 py-10 hidden">Sin registros</p>
          <p id="err" class="text-center text-red-500 py-4"></p>
        </div>
      </div>

      <div class="flex justify-center mt-6">
        <button id="loadMoreBtn" class="btn hidden"><i class="fas fa-plus"></i><span>Cargar más</span></button>
      </div>
    </div>
  </main>

<script>
// === Supabase ===
const SUPABASE_URL = "https://ecmjxpnpdgmvnxmbciur.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjbWp4cG5wZGdtdm54bWJjaXVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTkyOTcsImV4cCI6MjA3MTY5NTI5N30.ARF49W4hlEbS9KSu2jAeN-W-Q0ORTbHowfVaZv62Cis";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { persistSession: true, autoRefreshToken: true } });

// === Estado global ===
let current = 'accesos';
let page = 0;
const PAGE_SIZE = 50;
let lastBatchCount = 0;
let __rowStripeIndex = 0;
let paqueteriaEstado = 'todos';
const ADMIN_USER_IDS = [
  '01a11c78-bfa7-4c27-b78d-df4ad1493faa','4ca8992b-7a3a-41d1-9c1e-59062a70e7dc'
];

// === Helpers DOM ===
const byId = (id) => document.getElementById(id);
const thead = byId('thead');
const rows  = byId('rows');
const recordCount = byId('recordCount');
const empty = byId('empty');
const errEl = byId('err');
const kHorasVal = byId('k_horas');

// === Utils ===
const esc = (s)=> String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
const formatMoney = (n)=> new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0));

function calcHoras(r){
  try{
    if(!r.f_ing || !r.h_ing || !r.f_sal || !r.h_sal) return null;
    const ini = new Date(r.f_ing + 'T' + r.h_ing);
    const fin = new Date(r.f_sal + 'T' + r.h_sal);
    if (isNaN(ini) || isNaN(fin) || fin < ini) return null;
    const min = Math.round((fin-ini)/60000);
    return (min>=60? Math.floor(min/60)+'h ' : '') + (min%60)+'m';
  }catch(_){ return null; }
}
function totalHoras(list){
  let min=0;
  for(const r of list){
    if(!r.f_ing||!r.h_ing||!r.f_sal||!r.h_sal) continue;
    const a = new Date(r.f_ing+'T'+r.h_ing), b = new Date(r.f_sal+'T'+r.h_sal);
    if(!isNaN(a)&&!isNaN(b)&&b>=a){ min += Math.round((b-a)/60000); }
  }
  return min? ((min>=60? Math.floor(min/60)+'h ':'')+(min%60)+'m') : null;
}
function actions(id){
  return `<div class="flex gap-2">
    <button class="btn" onclick="editRow('${id}')"><i class='fas fa-pen'></i> Editar</button>
    <button class="btn" onclick="deleteRow('${id}')"><i class='fas fa-trash'></i> Eliminar</button>
  </div>`;
}

// === Helpers de Paquetería ===
const ESTADOS_PAQ = {'en cabina':'status-warning','entregado':'status-success'};
function normalizeEstado(v){ if(!v) return 'en cabina'; return v.toString().trim().toLowerCase().replace(/\s+/g,' '); }
function humanize(str){ return str.split(' ').map(s=> s? s[0].toUpperCase()+s.slice(1):s).join(' '); }
function estadoBadge(v){
  const key = normalizeEstado(v);
  const cls = ESTADOS_PAQ[key] || 'status-info';
  const label = humanize(key);
  return `<span class="status-badge ${cls}">${label}</span>`;
}

// === Definición de tabs ===
const tabs = {
  accesos: {
    table: "accesos",
    head: ["Nombre","DNI","Vehículo","Dominio","Motivo","F.Ing","H.Ing","F.Sal","H.Sal","Horas",""],
    row: r => {
      const horas = calcHoras(r);
      return [r.nombre,r.dni,r.vehiculo,r.dominio,r.motivo,r.f_ing,r.h_ing,r.f_sal,r.h_sal, horas!=null?horas:"—", actions(r.id)];
    },
    icon: "fas fa-door-open",
    showHorasKpi: true
  },
  paqueteria: {
    table: "paqueteria",
    head: ["Receptor","Descripción","N° ID","Estado","Fecha","Hora","Entregado a","F. Entrega","H. Entrega","Notas",""],
    row: r => [
      r.receptor, r.descripcion, r.id_num,
      estadoBadge(r.estado),
      r.fecha, r.hora,
      r.entregado_a || "—", r.fecha_entrega || "—", r.hora_entrega || "—",
      r.notas || "", actions(r.id)
    ],
    icon: "fas fa-box"
  },
  contable: {
    table: "movimientos",
    head: ["Tipo","Concepto","Monto","Fecha","Comprobante",""],
    row: r => [r.tipo, r.concepto, formatMoney(r.monto), r.fecha, r.url? `<a href="${r.url}" target="_blank" class="underline text-amber-700">Ver</a>` : "—", actions(r.id)],
    icon: "fas fa-calculator",
    kpis: true
  },
  parte: {
    table: "parte_diario",
    head: ["Fecha","Inicio","Fin","Caja chica","Resumen",""],
    row: r => [r.fecha, r.hora_inicio||"—", r.hora_fin||"—", r.caja_chica? formatMoney(r.caja_chica):"—", (r.resumen||r.notas||"").toString().slice(0,80), actions(r.id)],
    icon: "fas fa-clipboard-list"
  }
};

// === UI de tabs ===
function buildHead(){
  const cols = tabs[current].head || [];
  thead.innerHTML = `<tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr>`;
}
function applyTabUI(){
  byId('tableTitle').textContent = current==='accesos'?'Accesos': current==='paqueteria'?'Paquetería': current==='contable'?'Movimientos':'Parte diario';
  byId('tableIcon').className = tabs[current].icon || 'fas fa-table';
  byId('contableKpis').classList.toggle('hidden', current!=='contable');
  byId('accesosKpi').classList.toggle('hidden', current!=='accesos');
  byId('paqueteriaSubTabs').classList.toggle('hidden', current!=='paqueteria');
  if(current==='paqueteria') loadPaqueteriaCounts();
}
function resetPaging(){ page=0; lastBatchCount=0; }
function canLoadMore(){ return lastBatchCount===PAGE_SIZE; }

function updateTableInfo(){ /* hook tuyo, por compat */ }
function toggleExtras(){ /* hook tuyo, por compat */ }

function applyOrdering(q){
  // Orden por fecha/created_at desc según tabla
  if(current==='accesos') return q.order('f_ing',{ascending:false}).order('h_ing',{ascending:false});
  if(current==='paqueteria') return q.order('fecha',{ascending:false}).order('hora',{ascending:false});
  if(current==='contable') return q.order('fecha',{ascending:false});
  if(current==='parte') return q.order('fecha',{ascending:false});
  return q;
}

// === Carga ===
async function load(clearBefore = true){
  if (clearBefore) { rows.innerHTML=""; resetPaging(); __rowStripeIndex=0; }
  empty.classList.add('hidden'); errEl.textContent='';

  const desde = byId('fDesde').value;
  const hasta = byId('fHasta').value;
  const qText = byId('q').value.trim();

  let q = sb.from(tabs[current].table).select('*', { count:'exact', head:false });

  const dateCol = (current==='accesos')? 'f_ing' : 'fecha';
  if(desde) q = q.gte(dateCol, desde);
  if(hasta) q = q.lte(dateCol, hasta);

  if(qText){
    // búsqueda simple por columnas comunes
    if(current==='accesos'){
      q = q.or(`nombre.ilike.%${qText}%,dni.ilike.%${qText}%,vehiculo.ilike.%${qText}%,dominio.ilike.%${qText}%,motivo.ilike.%${qText}%`);
    }else if(current==='paqueteria'){
      q = q.or(`receptor.ilike.%${qText}%,descripcion.ilike.%${qText}%,id_num.ilike.%${qText}%,entregado_a.ilike.%${qText}%,notas.ilike.%${qText}%`);
    }else if(current==='contable'){
      q = q.or(`tipo.ilike.%${qText}%,concepto.ilike.%${qText}%`);
    }
  }

  // Filtro por sub-pestañas en Paquetería
  if(current==='paqueteria' && paqueteriaEstado && paqueteriaEstado!=='todos'){
    const norm = s=> s.toString().trim().toLowerCase().replace(/\s+/g,' ');
    q = q.eq('estado', norm(paqueteriaEstado));
  }

  // Paginación + orden
  q = applyOrdering(q);
  const from = page*PAGE_SIZE, to = from + PAGE_SIZE - 1;
  q = q.range(from,to);

  // Seguridad por usuario (si no admin)
  const { data:{ user } } = await sb.auth.getUser();
  const isAdmin = ADMIN_USER_IDS.includes(user?.id);
  if(!isAdmin) q = q.eq('user_id', user?.id);

  const { data, error, count } = await q;
  if(error){ errEl.textContent = error.message; byId('loadMoreBtn').classList.add('hidden'); return; }

  const list = data||[];
  lastBatchCount = list.length;

  if(clearBefore){ recordCount.textContent = `${count||0} registros`; }

  if(current==='accesos' && clearBefore){
    const th = totalHoras(list);
    kHorasVal.textContent = th? th : '—';
  }
  if(clearBefore && !list.length){
    empty.classList.remove('hidden');
    if(current==='contable') updateKpis([]);
    byId('loadMoreBtn').classList.add('hidden');
    return;
  }

  const estadoIdx = tabs[current].head.indexOf('Estado');

  for(const r of list){
    const arr = tabs[current].row(r);
    const t = arr.map((v,i)=>{
      const allowHtmlForEstado = (current==='paqueteria' && i===estadoIdx && typeof v==='string' && v.includes('status-badge'));
      const isLink   = (typeof v==='string' && /<a\s/i.test(v));
      const isAction = (i===arr.length-1);
      const raw = allowHtmlForEstado || isLink || isAction;
      return `<td>${raw? (v??'') : esc(v??'')}</td>`;
    }).join('');
    const stripe = (__rowStripeIndex % 2 === 0) ? '' : 'bg-amber-50/40';
    rows.insertAdjacentHTML('beforeend', `<tr class="${stripe}">${t}</tr>`);
    __rowStripeIndex++;
  }

  if(current==='contable' && clearBefore) updateKpis(list);

  byId('loadMoreBtn').classList.toggle('hidden', !canLoadMore());
}

// KPIs contable
function updateKpis(list){
  let ing=0,egr=0;
  for(const r of list){
    if(r.tipo==='Ingreso') ing += Number(r.monto||0);
    if(r.tipo==='Egreso')  egr += Number(r.monto||0);
  }
  byId('k_ing').textContent   = formatMoney(ing);
  byId('k_egr').textContent   = formatMoney(egr);
  byId('k_saldo').textContent = formatMoney(ing-egr);
}

// Contadores paquetería
async function loadPaqueteriaCounts(){
  try{
    const p = await sb.from('paqueteria').select('*',{count:'exact',head:true}).eq('estado','en cabina');
    const e = await sb.from('paqueteria').select('*',{count:'exact',head:true}).eq('estado','entregado');
    byId('pendientesCount').textContent = p.count||0;
    byId('entregadosCount').textContent = e.count||0;
  }catch(err){ console.warn('count paqueteria', err); }
}

// === Navegación de tabs ===
function setTab(name){
  current = name;
  document.querySelectorAll('[data-tab]').forEach(b=> b.classList.toggle('active', b.dataset.tab===name));
  rows.innerHTML='';
  buildHead();
  applyTabUI();
  resetPaging();
  load(true);
}

document.querySelectorAll('[data-tab]').forEach(b=>{
  b.addEventListener('click', ()=> setTab(b.dataset.tab));
});

// Sub-pestañas Paquetería
byId('tabPendientes').addEventListener('click', async ()=>{
  paqueteriaEstado = 'en cabina';
  byId('tabPendientes').classList.add('btn-gold'); byId('tabEntregados').classList.remove('btn-gold');
  resetPaging(); await load(true);
});
byId('tabEntregados').addEventListener('click', async ()=>{
  paqueteriaEstado = 'entregado';
  byId('tabEntregados').classList.add('btn-gold'); byId('tabPendientes').classList.remove('btn-gold');
  resetPaging(); await load(true);
});

// Botones filtros básicos
byId('filterBtn').addEventListener('click', ()=> load(true));
byId('clearBtn').addEventListener('click', ()=>{
  byId('fDesde').value=''; byId('fHasta').value=''; byId('q').value=''; paqueteriaEstado='todos'; load(true);
});
byId('showAllBtn').addEventListener('click', ()=>{ byId('fDesde').value=''; byId('fHasta').value=''; byId('q').value=''; load(true); });
byId('refreshBtn').addEventListener('click', ()=> load(true));

// Acciones
function editRow(id){ alert('Editar '+id+' (placeholder)'); }
async function deleteRow(id){
  if(!confirm('¿Eliminar registro?')) return;
  const { error } = await sb.from(tabs[current].table).delete().eq('id', id);
  if(error){ alert(error.message); return; }
  load(true);
}

// Sesión + init
(async ()=>{
  const { data } = await sb.auth.getSession();
  if(!data?.session){ location.replace('./index.html'); return; }
  byId('fDesde').value=''; byId('fHasta').value='';
  buildHead(); applyTabUI(); resetPaging(); await load(true);
})();
</script>
</body>
</html>
