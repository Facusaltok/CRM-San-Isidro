<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CRM — Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>

<!-- Overlay/z-index para modal (evita que el thead quede encima) -->
<style>
#overlay{position:fixed; inset:0; background:rgba(0,0,0,.45); backdrop-filter:blur(2px); z-index:9998; display:none}
.modal{position:fixed; left:50%; top:6vh; transform:translateX(-50%); z-index:10000; isolation:isolate}
body.modal-open{overflow:hidden}
.suggest{z-index:10001}
</style>
</head>
<body class="bg-white">
  <!-- Overlay global -->
  <div id="overlay"></div>

  <!-- HEADER -->
  <div class="flex items-center justify-between px-4 py-3 border-b bg-white">
    <h1 class="text-xl font-bold">CRM San Isidro</h1>
    <div class="flex items-center gap-2">
      <span id="whoami" class="text-slate-500 text-sm"></span>
      <button id="logoutBtn" class="px-3 py-1.5 rounded bg-black text-white">Salir</button>
    </div>
  </div>

  <!-- TABS -->
  <div class="px-4 pt-3 border-b bg-white">
    <div class="flex gap-2">
      <button class="tab px-3 py-2 rounded-t border bg-white font-semibold" data-tab="accesos">Accesos</button>
      <button class="tab px-3 py-2 rounded-t border" data-tab="paqueteria">Paquetería</button>
      <button class="tab px-3 py-2 rounded-t border" data-tab="personas">Personas</button>
      <button class="tab px-3 py-2 rounded-t border" data-tab="contable">Contable</button>
    </div>
  </div>

  <!-- VIEWS -->
  <div class="p-4 space-y-8">

    <!-- ACCESOS -->
    <section id="view-accesos">
      <div class="flex flex-wrap items-end gap-2 mb-3">
        <div class="grow">
          <label class="block text-sm text-slate-600">Buscar</label>
          <input id="acc-q" class="w-full border rounded-lg px-3 h-11" placeholder="nombre, DNI, vehículo, dominio, motivo…" />
        </div>
        <div>
          <label class="block text-sm text-slate-600">Desde</label>
          <input id="acc-desde" type="date" class="border rounded-lg px-3 h-11" />
        </div>
        <div>
          <label class="block text-sm text-slate-600">Hasta</label>
          <input id="acc-hasta" type="date" class="border rounded-lg px-3 h-11" />
        </div>
        <div class="flex gap-2">
          <button id="acc-filtrar" class="px-3 h-11 rounded-lg bg-black text-white">Buscar</button>
          <button id="acc-limpiar" class="px-3 h-11 rounded-lg border">Limpiar</button>
        </div>
      </div>
      <div class="overflow-auto border rounded-xl bg-white">
        <table class="min-w-[1000px] w-full">
          <thead class="bg-white sticky top-0 border-b">
            <tr class="[&>th]:text-left [&>th]:px-3 [&>th]:py-2">
              <th>Nombre</th><th>DNI</th><th>Vehículo</th><th>Dominio</th><th>Motivo</th>
              <th>F. Ingreso</th><th>H. Ingreso</th><th>F. Salida</th><th>H. Salida</th><th>Creado</th>
            </tr>
          </thead>
          <tbody id="acc-rows" class="[&>tr>td]:px-3 [&>tr>td]:py-2"></tbody>
        </table>
      </div>
    </section>

    <!-- PAQUETERÍA -->
    <section id="view-paqueteria" hidden>
      <div class="flex flex-wrap items-end gap-2 mb-3">
        <div class="grow">
          <label class="block text-sm text-slate-600">Buscar</label>
          <input id="paq-q" class="w-full border rounded-lg px-3 h-11" placeholder="receptor, entregado a, descripción, id, empresa…" />
        </div>
        <div>
          <label class="block text-sm text-slate-600">Desde</label>
          <input id="paq-desde" type="date" class="border rounded-lg px-3 h-11" />
        </div>
        <div>
          <label class="block text-sm text-slate-600">Hasta</label>
          <input id="paq-hasta" type="date" class="border rounded-lg px-3 h-11" />
        </div>
        <div class="flex gap-2">
          <button id="paq-filtrar" class="px-3 h-11 rounded-lg bg-black text-white">Buscar</button>
          <button id="paq-limpiar" class="px-3 h-11 rounded-lg border">Limpiar</button>
        </div>
      </div>
      <div class="overflow-auto border rounded-xl bg-white">
        <table class="min-w-[1200px] w-full">
          <thead class="bg-white sticky top-0 border-b">
            <tr class="[&>th]:text-left [&>th]:px-3 [&>th]:py-2">
              <th>Receptor</th><th>Empresa</th><th>Remito</th><th>Estado</th><th>Fecha</th><th>Hora</th>
              <th>Descripción</th><th>ID Nº</th><th>Entregado a</th><th>F. Entrega</th><th>H. Entrega</th><th>Notas</th><th>Creado</th>
            </tr>
          </thead>
          <tbody id="paq-rows" class="[&>tr>td]:px-3 [&>tr>td]:py-2"></tbody>
        </table>
      </div>
    </section>

    <!-- PERSONAS -->
    <section id="view-personas" hidden>
      <div class="flex flex-wrap items-end gap-2 mb-3">
        <div class="grow">
          <label class="block text-sm text-slate-600">Buscar</label>
          <input id="per-q" class="w-full border rounded-lg px-3 h-11" placeholder="nombre, DNI, teléfono, email…" />
        </div>
        <div class="flex gap-2">
          <button id="per-filtrar" class="px-3 h-11 rounded-lg bg-black text-white">Buscar</button>
          <button id="per-limpiar" class="px-3 h-11 rounded-lg border">Limpiar</button>
        </div>
      </div>
      <div class="overflow-auto border rounded-xl bg-white">
        <table class="min-w-[800px] w-full">
          <thead class="bg-white sticky top-0 border-b">
            <tr class="[&>th]:text-left [&>th]:px-3 [&>th]:py-2">
              <th>Nombre</th><th>DNI</th><th>Teléfono</th><th>Email</th><th>Creado</th>
            </tr>
          </thead>
          <tbody id="per-rows" class="[&>tr>td]:px-3 [&>tr>td]:py-2"></tbody>
        </table>
      </div>
    </section>

    <!-- CONTABLE (genérico si existe la tabla) -->
    <section id="view-contable" hidden>
      <div class="mb-3 text-slate-600 text-sm">
        Si existe la tabla <code>contable</code> en Supabase, se mostrará aquí de forma genérica con todas las columnas.
      </div>
      <div class="overflow-auto border rounded-xl bg-white">
        <table class="min-w-[900px] w-full">
          <thead id="con-head" class="bg-white sticky top-0 border-b"></thead>
          <tbody id="con-rows" class="[&>tr>td]:px-3 [&>tr>td]:py-2"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Modal de ejemplo (si lo necesitás; el overlay ya lo cubre) -->
  <div id="modal" class="modal hidden">
    <div class="bg-white border rounded-xl shadow-xl w-[min(900px,96vw)] max-h-[80vh] overflow-auto">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <b id="modalTitle">Modal</b>
        <button id="closeModalBtn" class="px-3 py-1.5 rounded border">Cerrar</button>
      </div>
      <div id="modalBody" class="p-4">
        Contenido…
      </div>
    </div>
  </div>

<script>
  // === Credenciales de tu proyecto Supabase ===
  const SUPABASE_URL = "https://ecmjxpnpdgmvnxmbciur.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjbWp4cG5wZGdtdm54bWJjaXVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTkyOTcsImV4cCI6MjA3MTY5NTI5N30.ARF49W4hlEbS9KSu2jAeN-W-Q0ORTbHowfVaZv62Cis";
  const sb = window.sb || supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // Verificar sesión al cargar
  (async () => {
    const { data } = await sb.auth.getSession();
    if (!data?.session) location.replace('index.html');
    document.getElementById('whoami').textContent = data.session.user?.email || '';
  })();

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try{ await sb.auth.signOut(); }catch(e){}
    location.href = 'index.html';
  });

  // Tabs
  const tabs = Array.from(document.querySelectorAll('.tab'));
  const views = {
    accesos: document.getElementById('view-accesos'),
    paqueteria: document.getElementById('view-paqueteria'),
    personas: document.getElementById('view-personas'),
    contable: document.getElementById('view-contable'),
  };
  tabs.forEach(b=>{
    b.addEventListener('click', ()=>{
      tabs.forEach(x=> x.classList.toggle('bg-white', x===b));
      Object.values(views).forEach(v=> v.hidden = true);
      const t = b.dataset.tab; views[t].hidden = false;
      if (t==='accesos') loadAccesos();
      if (t==='paqueteria') loadPaqueteria();
      if (t==='personas') loadPersonas();
      if (t==='contable') loadContable();
    });
  });

  // Modal helpers (overlay fix)
  const overlay = document.getElementById('overlay');
  const modal = document.getElementById('modal');
  function openModal(){ overlay.style.display='block'; document.body.classList.add('modal-open'); modal.classList.remove('hidden'); }
  function closeModal(){ overlay.style.display='none'; document.body.classList.remove('modal-open'); modal.classList.add('hidden'); }
  document.getElementById('closeModalBtn').addEventListener('click', closeModal);

  // Utils
  const esc = s => (s??'').toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&gt;",">":"&gt;"==="&gt;"? "&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[m])); // safe-ish
  function toDate(v){ return v ? new Date(v) : null; }
  function between(dateStr, d1, d2){
    if (!dateStr) return true;
    const t = new Date(dateStr);
    if (d1 && t < d1) return false;
    if (d2 && t > d2) return false;
    return true;
  }

  // ======== ACCESOS ========
  async function loadAccesos(){
    const q = document.getElementById('acc-q').value.trim().toLowerCase();
    const d1 = toDate(document.getElementById('acc-desde').value);
    const d2 = document.getElementById('acc-hasta').value ? new Date(document.getElementById('acc-hasta').value + "T23:59:59") : null;

    const { data, error } = await sb.from('accesos').select('*').order('created_at', { ascending:false }).limit(1000);
    if (error){ console.error(error); return; }
    const rows = (data||[]).filter(r=>{
      const text = [r.nombre,r.dni,r.vehiculo,r.dominio,r.motivo].filter(Boolean).join(' ').toLowerCase();
      const okQ = !q || text.includes(q);
      const fechaRef = r.f_ing || r.created_at;
      const okD = between(fechaRef, d1, d2);
      return okQ && okD;
    }).map(r=>`
      <tr class="border-b last:border-0">
        <td>${esc(r.nombre)}</td>
        <td>${esc(r.dni)}</td>
        <td>${esc(r.vehiculo)}</td>
        <td>${esc(r.dominio)}</td>
        <td>${esc(r.motivo)}</td>
        <td>${esc(r.f_ing)}</td>
        <td>${esc(r.h_ing)}</td>
        <td>${esc(r.f_sal)}</td>
        <td>${esc(r.h_sal)}</td>
        <td>${esc(r.created_at)}</td>
      </tr>
    `).join('') || `<tr><td colspan="10" class="px-3 py-4 text-slate-500">Sin resultados</td></tr>`;

    document.getElementById('acc-rows').innerHTML = rows;
  }
  document.getElementById('acc-filtrar').addEventListener('click', loadAccesos);
  document.getElementById('acc-limpiar').addEventListener('click', ()=>{ document.getElementById('acc-q').value=''; document.getElementById('acc-desde').value=''; document.getElementById('acc-hasta').value=''; loadAccesos(); });

  // ======== PAQUETERÍA ========
  async function loadPaqueteria(){
    const q = document.getElementById('paq-q').value.trim().toLowerCase();
    const d1 = toDate(document.getElementById('paq-desde').value);
    const d2 = document.getElementById('paq-hasta').value ? new Date(document.getElementById('paq-hasta').value + "T23:59:59") : null;

    const { data, error } = await sb.from('paqueteria').select('*').order('created_at', { ascending:false }).limit(1000);
    if (error){ console.error(error); return; }
    const rows = (data||[]).filter(r=>{
      const text = [r.receptor,r.empresa,r.remito,r.estado,r.descripcion,r.id_num,r.entregado_a,r.notas].filter(Boolean).join(' ').toLowerCase();
      const okQ = !q || text.includes(q);
      const fechaRef = r.fecha || r.created_at;
      const okD = between(fechaRef, d1, d2);
      return okQ && okD;
    }).map(r=>`
      <tr class="border-b last:border-0">
        <td>${esc(r.receptor)}</td>
        <td>${esc(r.empresa)}</td>
        <td>${esc(r.remito)}</td>
        <td>${esc(r.estado)}</td>
        <td>${esc(r.fecha)}</td>
        <td>${esc(r.hora)}</td>
        <td>${esc(r.descripcion)}</td>
        <td>${esc(r.id_num)}</td>
        <td>${esc(r.entregado_a)}</td>
        <td>${esc(r.fecha_entrega)}</td>
        <td>${esc(r.hora_entrega)}</td>
        <td>${esc(r.notas)}</td>
        <td>${esc(r.created_at)}</td>
      </tr>
    `).join('') || `<tr><td colspan="13" class="px-3 py-4 text-slate-500">Sin resultados</td></tr>`;

    document.getElementById('paq-rows').innerHTML = rows;
  }
  document.getElementById('paq-filtrar').addEventListener('click', loadPaqueteria);
  document.getElementById('paq-limpiar').addEventListener('click', ()=>{ document.getElementById('paq-q').value=''; document.getElementById('paq-desde').value=''; document.getElementById('paq-hasta').value=''; loadPaqueteria(); });

  // ======== PERSONAS ========
  async function loadPersonas(){
    const q = document.getElementById('per-q').value.trim().toLowerCase();
    const { data, error } = await sb.from('personas').select('*').order('created_at', { ascending:false }).limit(1000);
    if (error){ console.error(error); return; }
    const rows = (data||[]).filter(r=>{
      const text = [r.nombre,r.dni,r.telefono,r.email].filter(Boolean).join(' ').toLowerCase();
      return !q || text.includes(q);
    }).map(r=>`
      <tr class="border-b last:border-0">
        <td>${esc(r.nombre)}</td>
        <td>${esc(r.dni)}</td>
        <td>${esc(r.telefono)}</td>
        <td>${esc(r.email)}</td>
        <td>${esc(r.created_at)}</td>
      </tr>
    `).join('') || `<tr><td colspan="5" class="px-3 py-4 text-slate-500">Sin resultados</td></tr>`;
    document.getElementById('per-rows').innerHTML = rows;
  }
  document.getElementById('per-filtrar').addEventListener('click', loadPersonas);
  document.getElementById('per-limpiar').addEventListener('click', ()=>{ document.getElementById('per-q').value=''; loadPersonas(); });

  // ======== CONTABLE (si existe) ========
  async function loadContable(){
    const head = document.getElementById('con-head');
    const body = document.getElementById('con-rows');
    const { data, error } = await sb.from('contable').select('*').order('created_at', { ascending:false }).limit(1000);
    if (error){ head.innerHTML=''; body.innerHTML = `<tr><td class="px-3 py-4 text-slate-500">No se encontró la tabla "contable".</td></tr>`; return; }
    const cols = data?.length ? Object.keys(data[0]) : [];
    head.innerHTML = `<tr class="[&>th]:text-left [&>th]:px-3 [&>th]:py-2">${cols.map(c=>`<th>${esc(c)}</th>`).join('')}</tr>`;
    body.innerHTML = (data||[]).map(r=>`
      <tr class="border-b last:border-0">
        ${cols.map(c=>`<td>${esc(r[c])}</td>`).join('')}
      </tr>
    `).join('') || `<tr><td class="px-3 py-4 text-slate-500">Sin datos</td></tr>`;
  }

  // Inicial: Accesos
  loadAccesos();
</script>
</body>
</html>
