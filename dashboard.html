<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CRM — DASHBOARD</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
<style>
  :root{ color-scheme: light; }
  /* TODO-UI: todo en MAYÚSCULAS visualmente */
  body, input, select, textarea, button, table, th, td, .tab, .chip, .badge, .label, .note { text-transform: uppercase; }
  body{ background:#fff; position:relative; overflow-x:hidden; }
  .gold-glow{ pointer-events:none; position:fixed; inset:-20% -20% auto auto; width:70vmax; height:70vmax; border-radius:50%;
    background: radial-gradient(closest-side, rgba(245,158,11,.12), transparent 70%); animation: floatGlow 16s ease-in-out infinite alternate; filter: blur(12px); z-index:0; }
  .gold-ribbon{ pointer-events:none; position:fixed; left:-10%; top:40%; width:120vmax; height:200px;
    background: linear-gradient(90deg, transparent, rgba(245,158,11,.08), transparent); transform: rotate(-6deg); animation: shimmer 10s linear infinite; z-index:0; }
  @keyframes floatGlow{ from{ transform: translate(0,0) scale(1) } to{ transform: translate(-6%,4%) scale(1.05) } }
  @keyframes shimmer{ 0%{ background-position:-200% 0 } 100%{ background-position:200% 0 } }
  .app-layer{ position:relative; z-index:1; }

  .tab{padding:.5rem .9rem;border-radius:.7rem;border:1px solid rgb(203 213 225);background:#f8fafc;color:#0f172a; transition: all .25s ease}
  .tab:hover{ transform: translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.06)}
  .tab.active{background:#f59e0b;color:#111827;border-color:#f59e0b}
  .chip{border:1px solid rgb(203 213 225);border-radius:999px;padding:.15rem .6rem;font-size:.75rem; transition: background .2s ease}
  .chip:hover{ background:#f1f5f9}
  .kpi{border:1px solid rgb(226 232 240);border-radius:14px;background:#fff;padding:12px; box-shadow:0 10px 24px rgba(0,0,0,.06)}
  .table-wrap{max-height:65vh; overflow:auto;}
  .modal-body{max-height:75vh; overflow:auto;}
  .btn{padding:.55rem .95rem;border-radius:.8rem;border:1px solid rgb(203 213 225);background:#fff; transition: all .25s ease}
  .btn:hover{ transform: translateY(-1px); box-shadow:0 10px 24px rgba(0,0,0,.08)}
  .btn-gold{background:#f59e0b;color:#111827;border-color:#f59e0b}
  .label{display:block;font-size:.75rem;color:#475569;margin-bottom:.25rem}
  .input{width:100%;padding:.6rem .85rem;border:1px solid #cbd5e1;border-radius:.75rem;outline:none; transition:border-color .2s ease, box-shadow .2s ease}
  .input:focus{ border-color:#f59e0b; box-shadow:0 0 0 4px rgba(245,158,11,.15)}
  .section{border:1px solid #e5e7eb;border-radius:12px; box-shadow:0 8px 18px rgba(0,0,0,.04)}
  .section summary{cursor:pointer;list-style:none;padding:.6rem .9rem;border-bottom:1px solid #e5e7eb;background:#f8fafc;border-radius:12px 12px 0 0}
  .section .content{padding:.8rem .9rem}
  .suggest{position:absolute; z-index:70; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 16px 32px rgba(0,0,0,.12); max-height:220px; overflow:auto; width:100%}
  .suggest li{padding:.55rem .7rem; cursor:pointer}
  .suggest li:hover{background:#fff7ed}
  .note{font-size:.78rem;color:#64748b}
  .badge{font-size:.72rem;border:1px solid #e5e7eb;border-radius:999px;padding:.1rem .5rem}

  .row-fade{ animation: fadeInUp .35s ease both}
  @keyframes fadeInUp{ from{ opacity:0; transform: translateY(6px)} to{ opacity:1; transform: translateY(0)} }
  .row-gold{ background:#fff8e6 }
  .row-blank{ background:#ffffff }

  thead.sticky-head th{ position: sticky; top:0; background:#fdfaf5; z-index:10; box-shadow:0 1px 0 #e5e7eb}

  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center;
          background:rgba(0,0,0,.4); backdrop-filter: blur(2px); z-index:100; }
  .modal.show{ display:flex; }
  .modal-card{ width:100%; max-width: 64rem; background:#fff; border:1px solid #e5e7eb; border-radius:1rem;
               box-shadow:0 20px 60px rgba(0,0,0,.25); position:relative; z-index:101; }
  body.modal-open{ overflow:hidden; }

  .secure-badge{display:flex;align-items:center;gap:.45rem;padding:.45rem .65rem;border:1px dashed #f59e0b20;border-radius:10px;background:linear-gradient(180deg,#fff, #fffdf7)}
  .secure-badge p{ font-size:.72rem; color:#6b7280 }
  .lock{width:14px;height:14px;border:2px solid #9ca3af;border-radius:3px; position:relative}
  .lock:before{content:""; position:absolute; left:50%; transform:translateX(-50%); top:-6px; width:8px; height:6px; border:2px solid #9ca3af; border-bottom:none; border-radius:6px 6px 0 0}
</style>
</head>
<body class="min-h-screen text-slate-800">
  <div class="gold-glow"></div><div class="gold-ribbon"></div>
  <div class="app-layer">
    <header class="max-w-6xl mx-auto px-4 py-6 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-xl bg-amber-400 text-slate-900 font-extrabold flex items-center justify-center shadow-sm">CRM</div>
        <div><h1 class="text-2xl font-semibold leading-tight">SAN ISIDRO</h1><p class="text-xs text-slate-500">PANEL</p></div>
      </div>
      <div class="flex items-center gap-2">
        <button id="refreshBtn" class="btn">ACTUALIZAR</button>
        <button id="exportBtn"  class="btn btn-gold">EXPORTAR PDF</button>
        <button id="exportCsvBtn" class="btn">EXPORTAR CSV</button>
        <button id="logoutBtn"  class="btn">SALIR</button>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 pb-16">
      <nav class="flex gap-2 mb-4">
        <button data-tab="accesos"    class="tab active">ACCESOS</button>
        <button data-tab="paqueteria" class="tab">PAQUETERÍA</button>
        <button data-tab="contable"   class="tab">CONTABLE</button>
        <button data-tab="agenda"     class="tab">AGENDA</button>
        <button data-tab="parte"      class="tab">PARTE DIARIO</button>
      </nav>

      <section class="rounded-2xl bg-white border border-slate-200 shadow-2xl p-4">
        <div class="flex items-end gap-3 flex-wrap">
          <div><label class="label">DESDE</label><input id="fDesde" type="date" class="input"></div>
          <div><label class="label">HASTA</label><input id="fHasta" type="date" class="input"></div>

          <div id="wrapAsignado" class="hidden">
            <label class="label">ASIGNADO A</label>
            <div class="flex gap-1 items-center">
              <select id="asignado" class="input" style="width:auto">
                <option>Todos</option><option>Amalia</option><option>Valentino</option><option>Otros</option>
              </select>
              <button class="chip" data-quick="Amalia">AMALIA</button>
              <button class="chip" data-quick="Valentino">VALENTINO</button>
              <button class="chip" data-quick="Otros">OTROS</button>
            </div>
          </div>

          <div class="flex-1 min-w-[220px]">
            <label class="label">BUSCAR</label>
            <input id="q" type="text" placeholder="TEXTO LIBRE (NOMBRE, APELLIDO, DNI, ETC.)" class="input">
            <div class="note mt-1" id="extraHint"></div>
          </div>

          <button id="newBtn" class="btn btn-gold">+ NUEVO</button>
          <button id="filterBtn" class="btn">BUSCAR</button>
          <button id="clearBtn" class="btn">LIMPIAR</button>
          <button id="showAllBtn" class="btn">MOSTRAR TODO</button>
        </div>

        <div id="contableKpis" class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4 hidden">
          <div class="kpi"><div class="text-xs text-slate-500">INGRESOS</div><div id="k_ing" class="text-lg font-semibold">—</div></div>
          <div class="kpi"><div class="text-xs text-slate-500">EGRESOS</div><div id="k_egr" class="text-lg font-semibold">—</div></div>
          <div class="kpi"><div class="text-xs text-slate-500">SALDO</div><div id="k_saldo" class="text-lg font-semibold">—</div></div>
        </div>

        <div id="accesosKpi" class="kpi mt-4 hidden">
          <div class="flex items-center justify-between gap-2">
            <div>
              <div class="text-xs text-slate-500">TOTAL HORAS (LISTA FILTRADA)</div>
              <div id="k_horas" class="text-lg font-semibold">—</div>
            </div>
            <span id="k_horas_badge" class="badge">ACCESOS</span>
          </div>
        </div>

        <div class="table-wrap mt-4">
          <table class="min-w-full">
            <thead id="thead" class="text-sm text-slate-700 sticky-head"></thead>
            <tbody id="rows" class="text-sm"></tbody>
          </table>
          <p id="empty" class="text-center text-slate-500 py-6 hidden">SIN REGISTROS</p>
          <p id="err" class="text-center text-red-500 py-2"></p>
        </div>

        <div class="flex justify-center mt-4">
          <button id="loadMoreBtn" class="btn hidden">CARGAR MÁS</button>
        </div>
      </section>

      <div class="secure-badge mt-6">
        <span class="lock"></span>
        <p>TUS DATOS VIAJAN CIFRADOS (TLS) Y SE ALMACENAN CON ENCRIPTACIÓN EN REPOSO. ACCESO RESTRINGIDO POR ROLES Y AUTENTICACIÓN.</p>
      </div>
    </main>

    <!-- MODAL -->
    <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-card p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 id="modalTitle" class="text-lg font-semibold">NUEVO</h3>
          <div class="flex gap-2"><button id="closeModal" class="btn">CERRAR</button></div>
        </div>
        <form id="form" class="grid md:grid-cols-2 gap-3 modal-body"></form>
        <div class="mt-4 flex justify-between items-center gap-2">
          <div id="hint" class="text-xs text-slate-500"></div>
          <div class="flex gap-2"><button id="saveBtn" class="btn btn-gold">GUARDAR</button></div>
        </div>
      </div>
    </div>
  </div>

<script>
const sb = supabase.createClient(
  "https://ecmjxpnpdgmvnxmbciur.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjbWp4cG5wZGdtdm54bWJjaXVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTkyOTcsImV4cCI6MjA3MTY5NTI5N30.ARF49W4hlEbS9KSu2jAeN-W-Q0ORTbHowfVaZv62Cis"
);

const WHATSAPP_MODE  = 'chooser';
const WHATSAPP_PHONE = '54911XXXXXXXX';

/* ==== TABS Y COLUMNAS (con fecha formateada) ==== */
const tabs = {
  accesos: {
    table: "accesos",
    head: ["NOMBRE","DNI","VEHÍCULO","DOMINIO","MOTIVO","F.ING","H.ING","F.SAL","H.SAL","HORAS",""],
    fields: [
      {k:"nombre",   l:"PERSONA",   t:"text", r:true, autocomplete: "personas"},
      {k:"dni",      l:"DNI",       t:"text", autocomplete: "personas"},
      {k:"vehiculo", l:"VEHÍCULO",  t:"text"},
      {k:"dominio",  l:"DOMINIO",   t:"text"},
      {k:"motivo",   l:"MOTIVO",    t:"text"},
      {k:"f_ing",    l:"FECHA INGRESO", t:"date"},
      {k:"h_ing",    l:"HORA INGRESO",  t:"time"},
      {k:"f_sal",    l:"FECHA SALIDA",  t:"date"},
      {k:"h_sal",    l:"HORA SALIDA",   t:"time"}
    ],
    row: r => {
      const horas = calcHoras(r);
      return [r.nombre,r.dni,r.vehiculo,r.dominio,r.motivo, d(r.f_ing), r.h_ing, d(r.f_sal), r.h_sal, horas!=null?horas.toFixed(2):"—", actions(r.id)]
    },
    showHorasKpi: true
  },
  paqueteria: {
    table: "paqueteria",
    head: ["RECEPTOR","DESCRIPCIÓN","N° ID","ESTADO","FECHA","HORA","ENTREGADO A","F. ENTREGA","H. ENTREGA","NOTAS",""],
    fields: [
      {k:"receptor",    l:"RECEPTOR", t:"text", r:true},
      {k:"descripcion", l:"DESCRIPCIÓN", t:"text", r:true},
      {k:"id_num",      l:"N° ID", t:"text"},
      {k:"estado",      l:"ESTADO", t:"select", p:["EN CABINA","ENTREGADO"], r:true},
      {k:"fecha",       l:"FECHA",    t:"date"},
      {k:"hora",        l:"HORA",     t:"time"},
      {k:"entregado_a", l:"ENTREGADO A", t:"text"},
      {k:"fecha_entrega", l:"FECHA DE ENTREGA", t:"date"},
      {k:"hora_entrega",  l:"HORA DE ENTREGA",  t:"time"},
      {k:"notas",       l:"NOTAS",    t:"textarea"},
    ],
    row: r => [
      r.receptor, r.descripcion, r.id_num, r.estado, d(r.fecha), r.hora,
      r.entregado_a || "—", d(r.fecha_entrega) || "—", r.hora_entrega || "—",
      r.notas || "", actions(r.id)
    ]
  },
  contable: {
    table: "movimientos",
    head: ["TIPO","CONCEPTO","MONTO","FECHA","COMPROBANTE",""],
    fields: [
      {k:"tipo",     l:"TIPO",     t:"select", p:["INGRESO","EGRESO"], r:true},
      {k:"concepto", l:"CONCEPTO", t:"text", r:true},
      {k:"monto",    l:"MONTO (ARS)", t:"number", r:true},
      {k:"fecha",    l:"FECHA",    t:"date"},
      {k:"file",     l:"COMPROBANTE (IMAGEN)", t:"file"},
    ],
    row: r => [r.tipo,r.concepto,formatMoney(r.monto),d(r.fecha), r.url ? `<a class="underline text-amber-700" target="_blank" href="${r.url}">VER</a>`:"—", actions(r.id)],
    kpis: true
  },
  agenda: {
    table: "agenda_dom",
    head: ["ASIGNADO","TAREA","FECHA","HORA","ESTADO","NOTAS",""],
    fields: [
      {k:"asignado_a", l:"ASIGNADO A", t:"select", p:["AMALIA","VALENTINO","OTROS"], r:true},
      {k:"tarea",      l:"TAREA",   t:"text", r:true},
      {k:"fecha",      l:"FECHA",   t:"date", r:true},
      {k:"hora",       l:"HORA",    t:"time"},
      {k:"estado",     l:"ESTADO",  t:"select", p:["PENDIENTE","CONFIRMADO","COMPLETADO","CANCELADO"], r:true},
      {k:"notas",      l:"NOTAS",   t:"textarea"},
    ],
    row: r => [r.asignado_a, r.tarea, d(r.fecha), r.hora||"--:--", r.estado, r.notas||"", actions(r.id)],
    agendaFilter: true
  },
  parte: {
    table: "parte_diario",
    head: ["FECHA","INICIO","FIN","CAJA CHICA","RESUMEN",""],
    fields: [
      {k:"fecha",       l:"FECHA", t:"date", r:true},
      {k:"hora_inicio", l:"HORA INICIO", t:"time"},
      {k:"hora_fin",    l:"HORA FIN", t:"time"},
      {k:"caja_chica",  l:"CAJA CHICA (ARS)", t:"number"},
      {k:"cabina",         l:"CABINA", t:"textarea"},
      {k:"amt",            l:"AMT", t:"textarea"},
      {k:"puesto_hudson",  l:"PUESTO HUDSON", t:"textarea"},
      {k:"c1", l:"CHOFER C-1", t:"text"},
      {k:"c2", l:"CHOFER C-2", t:"text"},
      {k:"c3", l:"CHOFER C-3", t:"text"},
      {k:"c4", l:"CHOFER C-4", t:"text"},
      {k:"v_trailblazer", l:"TRAILBLAZER", t:"text"},
      {k:"v_amarok",      l:"AMAROK", t:"text"},
      {k:"v_sw4",         l:"SW4", t:"text"},
      {k:"v_corolla",     l:"TOYOTA COROLLA", t:"text"},
      {k:"v_q5",          l:"Q5", t:"text"},
      {k:"v_q7",          l:"Q7", t:"text"},
      {k:"fam1", l:"FAMILIA #1", t:"text"},
      {k:"fam2", l:"FAMILIA #2", t:"text"},
      {k:"fam3", l:"FAMILIA #3", t:"text"},
      {k:"fam4", l:"FAMILIA #4", t:"text"},
      {k:"fam5", l:"FAMILIA #5", t:"text"},
      {k:"empleadas", l:"EMPLEADAS DOMÉSTICAS (UNA POR LÍNEA)", t:"textarea"},
      {k:"niniera",   l:"NIÑERA", t:"text"},
      {k:"tec_camaras",  l:"SISTEMAS DE CÁMARAS", t:"text"},
      {k:"tec_cerco",    l:"CERCO ELÉCTRICO", t:"text"},
      {k:"tec_portones", l:"PORTONES (DETALLE)", t:"text"},
      {k:"prof_jardinero",  l:"JARDINERO", t:"text"},
      {k:"prof_piletero",   l:"PILETERO", t:"text"},
      {k:"prof_paisajistas",l:"PAISAJISTAS", t:"text"},
      {k:"prof_fumigador",  l:"FUMIGADOR", t:"text"},
      {k:"prof_floristas",  l:"FLORISTAS", t:"text"},
      {k:"amigos_sra",      l:"AMIGOS DE LA SRA. (NOMBRE / DNI / VEHÍCULOS / DOMINIO)", t:"textarea"},
      {k:"amigos_isabella", l:"AMIGOS DE ISABELLA (NOMBRE / DNI / VEHÍCULOS / DOMINIO)", t:"textarea"},
      {k:"amigos_angie",    l:"AMIGOS DE ANGIE (NOMBRE / DNI / VEHÍCULOS / DOMINIO)", t:"textarea"},
      {k:"elementos", l:"ELEMENTOS ASIGNADOS (UNA POR LÍNEA)", t:"textarea"},
      {k:"otros",     l:"OTROS", t:"textarea"},
      {k:"agenda_texto", l:"AGENDA (TEXTO)", t:"textarea"},
    ],
    row: r => [d(r.fecha), r.hora_inicio||"--:--", r.hora_fin||"--:--", formatMoney(r.caja_chica), (r.cabina||r.otros||"").toString().slice(0,60)+"…", actions(r.id)]
  }
};

const thead = byId("thead"), rows = byId("rows"), empty = byId("empty"), errEl = byId("err");
const wrapAsignado = byId("wrapAsignado"), selAsignado = byId("asignado");
const contKpis = byId("contableKpis");
const kpiHoras = byId("accesosKpi"), kHorasVal = byId("k_horas"), kHorasBadge = byId("k_horas_badge");
const extraHint = byId("extraHint");

let current = "accesos", editingId = null;

/* Paginación */
const PAGE_SIZE = 200;
let page = 0;
let lastBatchCount = 0;
function resetPaging(){ page = 0; lastBatchCount = 0; byId('loadMoreBtn')?.classList.add('hidden'); }
function canLoadMore(){ return lastBatchCount === PAGE_SIZE; }

/* Ordenamiento descendente */
function applyOrdering(q){
  switch (current){
    case 'contable':  return q.order('fecha',{ascending:false,nullsFirst:false}).order('created_at',{ascending:false});
    case 'paqueteria':return q.order('fecha',{ascending:false,nullsFirst:false}).order('hora',{ascending:false,nullsFirst:false}).order('created_at',{ascending:false});
    case 'accesos':   return q.order('f_ing',{ascending:false,nullsFirst:false}).order('h_ing',{ascending:false,nullsFirst:false}).order('created_at',{ascending:false});
    case 'agenda':    return q.order('fecha',{ascending:false,nullsFirst:false}).order('hora',{ascending:false,nullsFirst:false}).order('created_at',{ascending:false});
    default:          return q.order('created_at',{ascending:false});
  }
}

(async () => {
  const { data } = await sb.auth.getSession();
  if (!data?.session) { location.replace("./index.html"); return; }

  extraHint.innerHTML = 'SUGERENCIA: BUSCÁ POR <b>NOMBRE, APELLIDO O DNI</b> PARA VER EL <b>TOTAL DE HORAS</b>.';

  byId("fDesde").value = "";
  byId("fHasta").value = "";
  buildHead(); toggleExtras(); resetPaging(); await load();
})();

document.querySelectorAll("[data-tab]").forEach(b=>{
  b.addEventListener("click", async ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    current = b.dataset.tab; editingId=null;
    buildHead(); toggleExtras(); resetPaging(); await load(true);
  });
});
document.querySelectorAll('[data-quick]').forEach(btn=>{
  btn.addEventListener('click', ()=>{ selAsignado.value = btn.dataset.quick; resetPaging(); load(true); });
});
byId("logoutBtn").addEventListener("click", async ()=>{ await sb.auth.signOut(); location.replace("./index.html"); });

byId("refreshBtn").addEventListener("click", async ()=>{ resetPaging(); await load(true); });
byId("filterBtn").addEventListener("click", async ()=>{ resetPaging(); await load(true); });
byId("exportBtn").addEventListener("click", exportPDF);
byId("exportCsvBtn").addEventListener("click", exportCSV);
byId("clearBtn").addEventListener("click", async ()=>{
  byId("fDesde").value=""; byId("fHasta").value=""; selAsignado.value="Todos"; byId("q").value="";
  resetPaging(); await load(true);
});
byId("showAllBtn").addEventListener("click", async ()=>{
  byId("fDesde").value=""; byId("fHasta").value="";
  selAsignado.value="Todos"; byId("q").value="";
  resetPaging(); await load(true);
});
byId("loadMoreBtn").addEventListener("click", async ()=>{ page += 1; await load(false); });

/* Modal */
const modal = byId("modal"), form = byId("form"), hint = byId("hint");
byId("newBtn").addEventListener("click", () => openModal());
byId("closeModal").addEventListener("click", closeModal);
byId("saveBtn").addEventListener("click", save);

function openModal(data=null){
  document.body.classList.add('modal-open');
  modal.classList.add('show');
  openModalInner(data);
}
function closeModal(){
  modal.classList.remove('show');
  document.body.classList.remove('modal-open');
}

function toggleExtras(){
  wrapAsignado.classList.toggle("hidden", tabs[current].agendaFilter!==true);
  contKpis.classList.toggle("hidden", tabs[current].kpis!==true);
  kpiHoras.classList.toggle("hidden", tabs[current].showHorasKpi!==true);
  kHorasBadge.textContent = current === "accesos" ? "ACCESOS" : "";
}
function buildHead(){
  thead.innerHTML = `<tr class="border-b border-slate-200">${tabs[current].head.map(h=>`<th class="text-left py-2 pr-4">${h}</th>`).join("")}</tr>`;
}

/* Búsqueda server-side cuando hay texto */
function filterLocal(list){
  const q = byId("q").value.trim().toLowerCase();
  if (!q) return list;
  return list;
}
function buildSearchOr(current, q){
  const map = {
    accesos:    ["nombre","dni","vehiculo","dominio","motivo"],
    paqueteria: ["receptor","descripcion","id_num","estado","entregado_a","notas"],
    contable:   ["tipo","concepto"],
    agenda:     ["asignado_a","tarea","estado","notas"],
    parte:      ["cabina","amt","puesto_hudson","otros","agenda_texto"]
  };
  const fields = map[current] || [];
  return fields.map(f => `${f}.ilike.%${q}%`).join(",");
}

function actions(id){
  return `<div class="flex gap-2">
    <button class="chip" onclick="editRow('${id}')">EDITAR</button>
    <button class="chip" style="border-color:#ef4444;color:#991b1b" onclick="deleteRow('${id}')">ELIMINAR</button>
  </div>`;
}

/* Horas */
function calcHoras(r){
  if (!r?.f_ing || !r?.h_ing || !r?.f_sal || !r?.h_sal) return null;
  const start = new Date(`${r.f_ing}T${r.h_ing}`);
  const end   = new Date(`${r.f_sal}T${r.h_sal}`);
  const ms = end - start;
  if (isNaN(ms) || ms < 0) return null;
  return ms / 3600000;
}
function totalHoras(list){
  let t=0; for(const r of list){ const h = calcHoras(r); if(h!=null) t+=h; }
  return t;
}

/* Fecha DD/MM/AAAA para tabla */
function d(iso){ if(!iso) return iso; const s=String(iso); const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s); if(!m) return s; return `${m[3]}/${m[2]}/${m[1]}`; }

window.editRow = async function(id){
  editingId = id;
  const { data, error } = await sb.from(tabs[current].table).select("*").eq("id", id).single();
  if (error){ alert(error.message); return; }
  openModal(data);
}
window.deleteRow = async function(id){
  const name = nice(current);
  if (!confirm(`¿ELIMINAR ESTE REGISTRO DE ${name}? ESTA ACCIÓN NO SE PUEDE DESHACER.`)) return;
  const { error } = await sb.from(tabs[current].table).delete().eq('id', id);
  if (error){ alert("ELIMINAR: " + error.message); return; }
  await load(true);
};

let __rowStripeIndex = 0;

async function load(clearBefore = true){
  if (clearBefore) { rows.innerHTML=""; resetPaging(); __rowStripeIndex = 0; }
  empty.classList.add("hidden"); errEl.textContent="";

  const desde = byId("fDesde").value, hasta = byId("fHasta").value;
  const qText = byId("q").value.trim();

  let q = sb.from(tabs[current].table).select("*", { count: "exact", head: false });

  const dateCol = current==="accesos" ? "f_ing" : current==="paqueteria" ? "fecha" : current==="contable" ? "fecha" : current==="agenda" ? "fecha" : "fecha";
  if (desde) q = q.gte(dateCol, desde);
  if (hasta) q = q.lte(dateCol, hasta);

  if (current==="agenda" && selAsignado.value!=="Todos") q = q.eq("asignado_a", selAsignado.value);

  if (qText){
    const orStr = buildSearchOr(current, qText);
    if (orStr) q = q.or(orStr);
  }

  q = applyOrdering(q);

  const from = page * PAGE_SIZE;
  const to   = from + PAGE_SIZE - 1;
  q = q.range(from, to);

  const { data, error } = await q;
  if (error){ errEl.textContent = error.message; byId('loadMoreBtn').classList.add('hidden'); return; }

  const list = qText ? (data||[]) : filterLocal(data||[]);
  lastBatchCount = (data||[]).length;

  if (current === "accesos" && clearBefore) {
    const th = totalHoras(list);
    kHorasVal.textContent = th ? `${th.toFixed(2)} H` : "—";
  }

  if (clearBefore && !list.length){
    empty.classList.remove("hidden");
    if(current==="contable") updateKpis([]);
    byId('loadMoreBtn').classList.add('hidden');
    return;
  }

  for (const r of list){
    const arr = tabs[current].row(r);
    const t = arr.map((v,i)=> {
      const isRaw = (typeof v === 'string' && /<a\s/i.test(v)) || i === arr.length - 1;
      return `<td class="py-2 pr-4 border-b border-slate-100 align-top">${isRaw ? (v ?? "") : esc(v ?? "")}</td>`;
    }).join("");

    const stripeClass = (__rowStripeIndex % 2 === 0) ? 'row-blank' : 'row-gold';
    rows.insertAdjacentHTML("beforeend", `<tr class="row-fade ${stripeClass}">${t}</tr>`);
    __rowStripeIndex++;
  }

  if (current==="contable" && clearBefore) updateKpis(list);
  byId('loadMoreBtn').classList.toggle('hidden', !canLoadMore());
}
function updateKpis(list){
  let ing=0,egr=0; for(const r of list){ if(r.tipo==="INGRESO") ing+=Number(r.monto||0); if(r.tipo==="EGRESO") egr+=Number(r.monto||0); }
  byId('k_ing').textContent   = formatMoney(ing);
  byId('k_egr').textContent   = formatMoney(egr);
  byId('k_saldo').textContent = formatMoney(ing-egr);
}

/* ===== Modal (render) ===== */
async function openModalInner(data=null){
  byId("modalTitle").textContent = (editingId? "EDITAR — ":"NUEVO — ") + nice(current);
  form.innerHTML=""; hint.innerHTML="";

  if (current==="parte"){
    renderParteForm(data);
  } else {
    for (const f of tabs[current].fields){
      form.insertAdjacentHTML("beforeend", fieldHTML(f, data? data[f.k] : null));
    }
    if (current==="accesos"){
      hint.innerHTML = 'TIP: ESCRIBÍ <b>NOMBRE, APELLIDO O DNI</b> PARA AUTOCOMPLETAR DESDE REGISTROS EXISTENTES.';
      attachPersonAutocomplete(); // ahora busca en PERSONAS y ACCESOS
    }
  }

  if (current==="parte"){
    hint.innerHTML = 'SECCIONES PLEGABLES CON AUTOCOMPLETADOS. WHATSAPP SE ABRE AL GUARDAR.';
    if (!editingId) {
      const hoy = new Date().toISOString().slice(0,10);
      const dte = byId("f_fecha"); if (dte) dte.value = hoy;
    }
  }
}

function fieldHTML(f, value){
  const base = `class="input"`; const v = value ?? "";
  if (f.t==="select")  return `<div><label class="label">${f.l}${f.r?" *":""}</label><select id="f_${f.k}" ${base}>${(f.p||[]).map(x=>`<option ${x===v?"selected":""}>${x}</option>`).join("")}</select></div>`;
  if (f.t==="textarea")return `<div class="md:col-span-2"><label class="label">${f.l}${f.r?" *":""}</label><textarea id="f_${f.k}" rows="3" ${base}>${v??""}</textarea></div>`;
  if (f.autocomplete === "personas"){
    return `<div class="relative">
      <label class="label">${f.l}${f.r?" *":""}</label>
      <input id="f_${f.k}" type="${f.t||'text'}" value="${v??""}" ${base} autocomplete="off" placeholder="${f.k==='nombre'?'EJ: JUAN PÉREZ':''}">
      <ul id="suggest_${f.k}" class="suggest hidden"></ul>
    </div>`;
  }
  return `<div><label class="label">${f.l}${f.r?" *":""}</label><input id="f_${f.k}" type="${f.t||'text'}" value="${v??""}" ${base}></div>`;
}

/* ====== AUTOCOMPLETE: PERSONAS + ACCESOS (DISTINCT) ====== */
function attachPersonAutocomplete(){
  const nameEl = byId('f_nombre');
  const dniEl  = byId('f_dni');
  const vehEl  = byId('f_vehiculo');
  const domEl  = byId('f_dominio');
  const sugName = byId('suggest_nombre');
  const sugDni  = byId('suggest_dni');

  const renderSug = (ul, items) => {
    if (!items?.length){ ul.classList.add('hidden'); ul.innerHTML = ""; return; }
    ul.innerHTML = items.map(p => `<li data-json='${JSON.stringify(p)}'>${esc((p.nombre||"").toUpperCase())} — <span class="text-slate-500">${esc((p.dni||"").toUpperCase())}</span></li>`).join("");
    ul.classList.remove('hidden');
    [...ul.querySelectorAll('li')].forEach(li=>{
      li.addEventListener('click', async ()=>{
        const p = JSON.parse(li.getAttribute('data-json'));
        if (nameEl) nameEl.value = (p.nombre || "").toUpperCase();
        if (dniEl)  dniEl.value  = (p.dni || "").toUpperCase();
        try{
          // completar último vehículo/dominio usado por esa persona en accesos
          let q = sb.from('accesos').select('vehiculo,dominio,created_at').order('created_at',{ascending:false}).limit(1);
          if (p.dni) q = q.eq('dni', p.dni);
          else if (p.nombre) q = q.ilike('nombre', p.nombre);
          const { data, error } = await q;
          if (!error && data && data[0]){
            if (vehEl && !vehEl.value) vehEl.value = (data[0].vehiculo || '').toUpperCase();
            if (domEl && !domEl.value) domEl.value = (data[0].dominio || '').toUpperCase();
          }
        }catch(e){ console.warn(e); }
        sugName?.classList.add('hidden'); sugDni?.classList.add('hidden');
      });
    });
  };

  // Buscar en PERSONAS y en ACCESOS DISTINCT, fusionar y deduplicar
  const unionSearch = async ({by, q})=>{
    q = q.trim();
    if(!q) return [];
    const limit = 10;
    const reqs = by==='nombre'
      ? [
          sb.from('personas').select('nombre,dni').ilike('nombre', `%${q}%`).limit(limit),
          sb.from('accesos').select('nombre,dni',{distinct:true}).ilike('nombre', `%${q}%`).limit(limit)
        ]
      : [
          sb.from('personas').select('nombre,dni').ilike('dni', `%${q}%`).limit(limit),
          sb.from('accesos').select('nombre,dni',{distinct:true}).ilike('dni', `%${q}%`).limit(limit)
        ];
    const res = await Promise.allSettled(reqs);
    const arr = res.flatMap(r => (r.status==="fulfilled" && r.value.data) ? r.value.data : []);
    // dedupe por dni+nombre
    const seen = new Set(); const out=[];
    for(const it of arr){
      const key = (it.dni||"") + "|" + (it.nombre||"");
      if(!seen.has(key)){ seen.add(key); out.push(it); }
    }
    return out.slice(0,limit);
  };

  let t1, t2;
  nameEl?.addEventListener('input', async ()=>{
    clearTimeout(t1);
    t1 = setTimeout(async ()=>{
      const q = nameEl.value;
      const items = await unionSearch({by:'nombre', q});
      renderSug(sugName, items);
    }, 220);
  });
  dniEl?.addEventListener('input', async ()=>{
    clearTimeout(t2);
    t2 = setTimeout(async ()=>{
      const q = dniEl.value;
      const items = await unionSearch({by:'dni', q});
      renderSug(sugDni, items);
    }, 220);
  });

  document.addEventListener('click', (e)=>{
    if (!sugName?.contains(e.target) && e.target!==nameEl) sugName?.classList.add('hidden');
    if (!sugDni?.contains(e.target)  && e.target!==dniEl)  sugDni?.classList.add('hidden');
  });
}

/* ===== GUARDAR: normalizo a MAYÚSCULAS ===== */
async function save(ev){
  ev?.preventDefault?.();
  const { data: u } = await sb.auth.getUser(); const uid = u?.user?.id; if (!uid){ alert("SESIÓN EXPIRADA"); return; }
  const def = tabs[current]; let payload = { user_id: uid };

  const PARTE_VIRTUAL = new Set([
    "c1","c2","c3","c4","v_trailblazer","v_amarok","v_sw4","v_corolla","v_q5","v_q7",
    "fam1","fam2","fam3","fam4","fam5","empleadas","niniera",
    "tec_camaras","tec_cerco","tec_portones","prof_jardinero","prof_piletero","prof_paisajistas","prof_fumigador","prof_floristas",
    "amigos_sra","amigos_isabella","amigos_angie","elementos"
  ]);

  for (const f of def.fields){
    if (f.k === "file") continue;
    if (current==="parte" && PARTE_VIRTUAL.has(f.k)) continue;
    const el = byId(`f_${f.k}`); if (!el) continue;
    let v = el.value;
    if (f.t==="number" && v!=="") v = Number(v);
    // Normalizo strings a MAYÚSCULAS (sin tocar fechas/horas/vacíos)
    if (typeof v === "string" && f.t!=="date" && f.t!=="time" && v!=="") v = v.toUpperCase().trim();
    if (f.r && (v===null || v==="")){ alert(`COMPLETÁ: ${f.l}`); return; }
    if (v==="") v = null;
    payload[f.k] = v;
  }

  if (current==="contable"){
    const fi = byId("f_file");
    if (fi && fi.files && fi.files.length){
      const file = fi.files[0];
      const path = `${uid}/${Date.now()}_${file.name}`;
      const up = await sb.storage.from("tickets").upload(path, file, { upsert: false });
      if (up.error){ alert("UPLOAD: " + up.error.message); return; }
      const { data: pub } = sb.storage.from("tickets").getPublicUrl(path);
      payload.url = pub?.publicUrl || null;
    }
  }

  // Si es acceso, intento upsert en PERSONAS (por si no existe)
  if (current==="accesos"){
    try{
      await sb.rpc('upsert_persona', {
        p_nombre: payload.nombre || null,
        p_dni:    payload.dni    || null,
        p_telefono: null,
        p_email:    null
      });
    }catch(e){ console.warn(e); }
  }

  let resp;
  if (editingId){ resp = await sb.from(def.table).update(payload).eq('id', editingId);
  } else { resp = await sb.from(def.table).insert(payload); }
  if (resp.error){ alert("GUARDAR: " + resp.error.message); return; }

  editingId = null;
  closeModal();
  await load(true);
}

/* Export */
function exportPDF(){
  const map = {accesos:"ACCESOS", paqueteria:"PAQUETERIA", contable:"CONTABLE", agenda:"AGENDA", parte:"PARTE DIARIO"};
  let head = [...document.querySelectorAll('#thead th')].map(th => th.textContent.trim()).slice(0,-1);
  let body = [...document.querySelectorAll('#rows tr')].map(tr => [...tr.children].slice(0,-1).map(td => td.innerText));

  if (!body.length){ alert("NO HAY DATOS PARA EXPORTAR."); return; }

  let resumenHoras = "";
  if (current==="accesos"){
    const rowsData = [...document.querySelectorAll('#rows tr')].map(tr => [...tr.children].map(td => td.innerText));
    const horas = rowsData.map(r => parseFloat(r[r.length-2].replace(',', '.'))).filter(n => !isNaN(n));
    const total = horas.reduce((a,b)=>a+b,0);
    resumenHoras = `TOTAL DE HORAS (LISTA): ${total.toFixed(2)} H`;
  }

  const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit:'pt', format:'a4' });
  const title = `CRM — ${map[current]}`;
  doc.setFontSize(14); doc.text(title, 40, 40);
  if (resumenHoras) { doc.setFontSize(11); doc.text(resumenHoras, 40, 58); }

  const startY = resumenHoras ? 72 : 60;
  doc.autoTable({ startY, head:[head], body, styles:{ fontSize:9, cellPadding:4 }, headStyles:{ fillColor:[245,158,11] }, theme:'striped' });
  doc.save(`${map[current]}_${new Date().toISOString().slice(0,10)}.pdf`);
}
function exportCSV(){
  const head = [...document.querySelectorAll('#thead th')].map(th => th.textContent.trim()).slice(0, -1);
  const rowsData = [...document.querySelectorAll('#rows tr')].map(tr => [...tr.children].slice(0, -1).map(td => td.innerText.replaceAll("\n"," ").trim()));
  if (!rowsData.length){ alert("NO HAY DATOS PARA EXPORTAR."); return; }
  const escCSV = (v) => { const s = String(v ?? ""); return /[",\n;]/.test(s) ? `"${s.replaceAll('"','""')}"` : s; };
  const csv = [head.map(escCSV).join(";")].concat(rowsData.map(r => r.map(escCSV).join(";"))).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"}); const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); const map = {accesos:"ACCESOS", paqueteria:"PAQUETERIA", contable:"CONTABLE", agenda:"AGENDA", parte:"PARTE_DIARIO"};
  a.href = url; a.download = `${map[current]}_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* Utils */
function byId(id){ return document.getElementById(id); }
function esc(v){ return (""+v).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function formatMoney(n){ const x = Number(n||0); return x.toLocaleString("es-AR",{style:"currency",currency:"ARS"}); }
function nice(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
function val(id){ const el=byId(id); return el? (el.value||null) : null; }
</script>
</body>
</html>
