<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CRM San Isidro — Dashboard</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<!-- jsPDF + AutoTable (PDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-/F1yV..." crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js" integrity="sha512-2mC..." crossorigin="anonymous"></script>

<!-- Fondo blanco + animación dorada -->
<style>
  :root{ color-scheme: light; }
  body{ background:#fff; position:relative; overflow-x:hidden; }
  .gold-glow{
    pointer-events:none; position:fixed; inset:-20% -20% auto auto;
    width:70vmax; height:70vmax; border-radius:50%;
    background: radial-gradient(closest-side, rgba(245, 158, 11, .12), transparent 70%);
    animation: floatGlow 16s ease-in-out infinite alternate; filter: blur(12px); z-index:0;
  }
  .gold-ribbon{
    pointer-events:none; position:fixed; left:-10%; top:40%;
    width:120vmax; height:200px;
    background: linear-gradient(90deg, transparent, rgba(245,158,11,.08), transparent);
    transform: rotate(-6deg); animation: shimmer 10s linear infinite; z-index:0;
  }
  @keyframes floatGlow{ from{ transform: translate(0,0) scale(1) } to{ transform: translate(-6%,4%) scale(1.05) } }
  @keyframes shimmer{ 0%{ background-position:-200% 0 } 100%{ background-position:200% 0 } }
  .app-layer{ position:relative; z-index:1; }
  .tab{padding:.5rem .9rem;border-radius:.7rem;border:1px solid rgb(203 213 225);background:#f8fafc;color:#0f172a}
  .tab.active{background:#f59e0b;color:#111827;border-color:#f59e0b}
  .chip{border:1px solid rgb(203 213 225);border-radius:999px;padding:.15rem .6rem;font-size:.75rem}
  .kpi{border:1px solid rgb(226 232 240);border-radius:14px;background:#fff;padding:12px}
</style>
</head>

<body class="min-h-screen text-slate-800">
  <div class="gold-glow"></div>
  <div class="gold-ribbon"></div>

  <div class="app-layer">
    <header class="max-w-6xl mx-auto px-4 py-6 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-xl bg-amber-400 text-slate-900 font-extrabold flex items-center justify-center">CRM</div>
        <div>
          <h1 class="text-2xl font-semibold leading-tight">San Isidro</h1>
          <p class="text-xs text-slate-500">Seguro y rápido</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-50">Actualizar</button>
        <button id="exportBtn"  class="px-3 py-2 rounded-lg bg-amber-400 text-slate-900 font-medium">Exportar PDF</button>
        <button id="logoutBtn"  class="px-3 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-50">Salir</button>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 pb-24">
      <!-- Tabs -->
      <nav class="flex gap-2 mb-4">
        <button data-tab="accesos"    class="tab active">Accesos</button>
        <button data-tab="paqueteria" class="tab">Paquetería</button>
        <button data-tab="contable"   class="tab">Contable</button>
        <button data-tab="agenda"     class="tab">Agenda</button>
        <button data-tab="parte"      class="tab">Parte diario</button>
      </nav>

      <!-- Panel principal -->
      <section class="rounded-2xl bg-white border border-slate-200 shadow-2xl p-4">
        <div class="flex items-end gap-3 flex-wrap">
          <div>
            <label class="block text-xs mb-1 text-slate-600">Desde</label>
            <input id="fDesde" type="date" class="px-3 py-2 rounded-lg bg-white border border-slate-300 outline-none focus:ring focus:ring-amber-300">
          </div>
          <div>
            <label class="block text-xs mb-1 text-slate-600">Hasta</label>
            <input id="fHasta" type="date" class="px-3 py-2 rounded-lg bg-white border border-slate-300 outline-none focus:ring focus:ring-amber-300">
          </div>

          <!-- Filtro asignado para Agenda -->
          <div id="wrapAsignado" class="hidden">
            <label class="block text-xs mb-1 text-slate-600">Asignado a</label>
            <div class="flex gap-1">
              <select id="asignado" class="px-3 py-2 rounded-lg bg-white border border-slate-300 outline-none focus:ring focus:ring-amber-300">
                <option>Todos</option><option>Amalia</option><option>Valentino</option><option>Otros</option>
              </select>
              <!-- atajos rápidos -->
              <button class="chip" data-quick="Amalia">Amalia</button>
              <button class="chip" data-quick="Valentino">Valentino</button>
              <button class="chip" data-quick="Otros">Otros</button>
            </div>
          </div>

          <div class="flex-1">
            <label class="block text-xs mb-1 text-slate-600">Buscar</label>
            <input id="q" type="text" placeholder="Nombre / DNI / Dominio / Ref."
              class="w-full px-3 py-2 rounded-lg bg-white border border-slate-300 outline-none focus:ring focus:ring-amber-300">
          </div>
          <button id="newBtn"   class="px-3 py-2 rounded-lg bg-amber-400 text-slate-900 font-medium">+ Nuevo</button>
          <button id="filterBtn" class="px-3 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-50">Filtrar</button>
          <button id="clearBtn"  class="px-3 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-50">Limpiar</button>
        </div>

        <!-- KPIs contables -->
        <div id="contableKpis" class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4 hidden">
          <div class="kpi"><div class="text-xs text-slate-500">Ingresos</div><div id="k_ing" class="text-lg font-semibold">—</div></div>
          <div class="kpi"><div class="text-xs text-slate-500">Egresos</div><div id="k_egr" class="text-lg font-semibold">—</div></div>
          <div class="kpi"><div class="text-xs text-slate-500">Saldo</div><div id="k_saldo" class="text-lg font-semibold">—</div></div>
        </div>

        <div class="overflow-x-auto mt-4">
          <table class="min-w-full">
            <thead id="thead" class="text-sm text-slate-600 bg-slate-50"></thead>
            <tbody id="rows"  class="text-sm"></tbody>
          </table>
          <p id="empty" class="text-center text-slate-500 py-6 hidden">Sin registros</p>
          <p id="err"   class="text-center text-red-500 py-2"></p>
        </div>
      </section>
    </main>

    <!-- Modal genérico -->
    <div id="modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center p-4">
      <div class="w-full max-w-3xl rounded-2xl bg-white border border-slate-200 p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 id="modalTitle" class="text-lg font-semibold">Nuevo</h3>
          <button id="closeModal" class="px-2 py-1 rounded-lg bg-white border border-slate-300 hover:bg-slate-50">Cerrar</button>
        </div>
        <form id="form" class="grid md:grid-cols-2 gap-3"></form>
        <div class="mt-4 flex justify-between items-center gap-2">
          <div id="hint" class="text-xs text-slate-500"></div>
          <div class="flex gap-2">
            <button id="saveBtn" class="px-3 py-2 rounded-lg bg-amber-400 text-slate-900 font-medium">Guardar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // Supabase
  const sb = supabase.createClient(
    "https://ecmjxpnpdgmvnxmbciur.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjbWp4cG5wZGdtdm54bWJjaXVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTkyOTcsImV4cCI6MjA3MTY5NTI5N30.ARF49W4hlEbS9KSu2jAeN-W-Q0ORTbHowfVaZv62Cis"
  );

  const WHATSAPP_PHONE = "54911XXXXXXXX";

  // Definición de pestañas (igual a tu base + mejoras contable/agenda/parteiario)
  const tabs = {
    accesos: {
      table: "accesos",
      head: ["Nombre","DNI","Vehículo","Dominio","Motivo","F.Ing","H.Ing","F.Sal","H.Sal"],
      fields: [
        {k:"nombre",   l:"Nombre",   t:"text", r:true},
        {k:"dni",      l:"DNI",      t:"text"},
        {k:"vehiculo", l:"Vehículo", t:"text"},
        {k:"dominio",  l:"Dominio",  t:"text"},
        {k:"motivo",   l:"Motivo",   t:"text"},
        {k:"f_ing",    l:"Fecha ingreso", t:"date"},
        {k:"h_ing",    l:"Hora ingreso",  t:"time"},
        {k:"f_sal",    l:"Fecha salida",  t:"date"},
        {k:"h_sal",    l:"Hora salida",   t:"time"},
      ],
      row: r => [r.nombre,r.dni,r.vehiculo,r.dominio,r.motivo,r.f_ing,r.h_ing,r.f_sal,r.h_sal],
      searchKeys: ["nombre","dni","dominio"]
    },
    paqueteria: {
      table: "paqueteria",
      head: ["Receptor","Empresa","Remito","Estado","Fecha","Hora","Notas"],
      fields: [
        {k:"receptor", l:"Receptor", t:"text", r:true},
        {k:"empresa",  l:"Empresa",  t:"text"},
        {k:"remito",   l:"Remito/Ref", t:"text"},
        {k:"estado",   l:"Estado", t:"text"},
        {k:"fecha",    l:"Fecha", t:"date"},
        {k:"hora",     l:"Hora",  t:"time"},
        {k:"notas",    l:"Notas", t:"text"},
      ],
      row: r => [r.receptor,r.empresa,r.remito,r.estado,r.fecha,r.hora,r.notas],
      searchKeys: ["receptor","empresa","remito","notas"]
    },
    contable: {
      table: "movimientos",
      head: ["Tipo","Concepto","Monto","Fecha","Comprobante"],
      fields: [
        {k:"tipo",     l:"Tipo", t:"select", p:["Ingreso","Egreso"], r:true},
        {k:"concepto", l:"Concepto", t:"text", r:true},
        {k:"monto",    l:"Monto (ARS)", t:"number", r:true},
        {k:"fecha",    l:"Fecha", t:"date"},
        {k:"file",     l:"Comprobante (imagen)", t:"file"},
      ],
      row: r => [r.tipo,r.concepto,formatMoney(r.monto),r.fecha, r.url ? `<a class="underline text-amber-700" target="_blank" href="${r.url}">Ver</a>`:"—"],
      searchKeys: ["concepto","tipo"]
    },
    agenda: {
      table: "agenda_dom",
      head: ["Asignado","Cliente","Servicio","Segmento","Fecha","Hora","Estado","Notas"],
      fields: [
        {k:"asignado_a", l:"Asignado a", t:"select", p:["Amalia","Valentino","Otros"], r:true},
        {k:"cliente",  l:"Cliente", t:"text", r:true},
        {k:"servicio", l:"Servicio", t:"text", r:true},
        {k:"segmento", l:"Segmento", t:"select", p:["Hatch/Sedán","SUV/PickUp","Motos"]},
        {k:"fecha",    l:"Fecha", t:"date"},
        {k:"hora",     l:"Hora", t:"time"},
        {k:"estado",   l:"Estado", t:"select", p:["Pendiente","Confirmado","Completado","Cancelado"]},
        {k:"notas",    l:"Notas", t:"text"},
      ],
      row: r => [r.asignado_a,r.cliente,r.servicio,r.segmento,r.fecha,r.hora,r.estado,r.notas],
      searchKeys: ["asignado_a","cliente","servicio","segmento","estado","notas"]
    },
    parte: {
      table: "parte_diario",
      head: ["Fecha","Inicio","Fin","Caja chica","Detalle"],
      fields: [
        {k:"fecha",        l:"Fecha", t:"date", r:true},
        {k:"hora_inicio",  l:"Hora inicio", t:"time"},
        {k:"hora_fin",     l:"Hora fin", t:"time"},
        {k:"caja_chica",   l:"Caja chica (ARS)", t:"number"},
        {k:"cabina",       l:"Cabina (texto)", t:"textarea"},
        {k:"amt",          l:"AMT (texto)", t:"textarea"},
        {k:"puesto_hudson",l:"Puesto Hudson (texto)", t:"textarea"},
        {k:"choferes",     l:"Choferes (coma separados)", t:"array"},
        {k:"novedades_vehiculos", l:"Novedades vehículos (JSON)", t:"json"},
        {k:"familia_en_quinta",   l:"Familia en quinta (JSON)", t:"json"},
        {k:"personal_domestico",  l:"Personal doméstico (JSON)", t:"json"},
        {k:"sistemas_tecnicos",   l:"Sistemas/Técnicos (JSON)", t:"json"},
        {k:"invitados",           l:"Invitados (JSON)", t:"json"},
        {k:"profesionales",       l:"Profesionales (JSON)", t:"json"},
        {k:"elementos_asignados", l:"Elementos asignados (coma separados)", t:"array"},
        {k:"otros",        l:"Otros (texto)", t:"textarea"},
        {k:"agenda_texto", l:"Agenda (texto)", t:"textarea"},
      ],
      row: r => [r.fecha,r.hora_inicio,r.hora_fin,formatMoney(r.caja_chica), (r.otros||r.cabina||r.amt||'').toString().slice(0,60)+'…'],
      searchKeys: ["otros","cabina","amt","puesto_hudson","agenda_texto"]
    }
  };

  // Estado UI
  let current = "accesos";
  const thead = document.getElementById("thead");
  const rows  = document.getElementById("rows");
  const empty = document.getElementById("empty");
  const errEl = document.getElementById("err");
  const wrapAsignado = document.getElementById("wrapAsignado");
  const selAsignado  = document.getElementById("asignado");
  const contKpis     = document.getElementById("contableKpis");

  // Requiere sesión
  (async () => {
    const { data } = await sb.auth.getSession();
    if (!data?.session) { location.replace("./index.html"); return; }

    // Por defecto: mostrar día de hoy
    const today = new Date(); const iso = today.toISOString().slice(0,10);
    document.getElementById("fDesde").value = iso;
    document.getElementById("fHasta").value = iso;

    buildHead();
    toggleAgendaFilter();
    await load();
  })();

  // Tabs
  document.querySelectorAll("[data-tab]").forEach(b=>{
    b.addEventListener("click", async ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      current = b.dataset.tab;
      buildHead();
      toggleAgendaFilter();
      await load();
    });
  });

  // Atajos agenda
  document.querySelectorAll('[data-quick]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      selAsignado.value = btn.dataset.quick;
      load();
    });
  });

  // Botones
  document.getElementById("logoutBtn").addEventListener("click", async ()=>{
    await sb.auth.signOut(); location.replace("./index.html");
  });
  document.getElementById("refreshBtn").addEventListener("click", load);
  document.getElementById("filterBtn").addEventListener("click", load);
  document.getElementById("exportBtn").addEventListener("click", exportPDF);
  document.getElementById("clearBtn").addEventListener("click", ()=>{
    document.getElementById("fDesde").value = "";
    document.getElementById("fHasta").value = "";
    document.getElementById("asignado").value = "Todos";
    document.getElementById("q").value = "";
    load();
  });

  // Modal
  const modal = document.getElementById("modal");
  const form  = document.getElementById("form");
  const hint  = document.getElementById("hint");
  document.getElementById("newBtn").addEventListener("click", openModal);
  document.getElementById("closeModal").addEventListener("click", ()=>modal.classList.add("hidden"));
  document.getElementById("saveBtn").addEventListener("click", save);

  function toggleAgendaFilter(){
    wrapAsignado.classList.toggle("hidden", current!=="agenda");
    contKpis.classList.toggle("hidden", current!=="contable");
  }

  function buildHead(){
    const h = tabs[current].head.map(h=>`<th class="text-left py-2 pr-4">${h}</th>`).join("");
    thead.innerHTML = `<tr class="border-b border-slate-200">${h}</tr>`;
  }

  function filterLocal(list){
    const q = document.getElementById("q").value.trim().toLowerCase();
    if (!q) return list;
    const keys = tabs[current].searchKeys || [];
    return list.filter(r => keys.some(k => `${r[k]||""}`.toLowerCase().includes(q)));
  }

  async function load(){
    rows.innerHTML = ""; empty.classList.add("hidden"); errEl.textContent="";
    const desde = document.getElementById("fDesde").value;
    const hasta = document.getElementById("fHasta").value;

    let q = sb.from(tabs[current].table).select("*").order("created_at",{ascending:false});

    // filtros por fecha
    if (current==="accesos"){ if (desde) q = q.gte("f_ing", desde); if (hasta) q = q.lte("f_ing", hasta); }
    if (["paqueteria","agenda","contable","parte"].includes(current)){
      const col = current==="contable" ? "fecha" : "fecha";
      if (desde) q = q.gte(col, desde);
      if (hasta) q = q.lte(col, hasta);
    }
    // filtro agenda por asignado
    if (current==="agenda" && selAsignado.value !== "Todos"){
      q = q.eq("asignado_a", selAsignado.value);
    }

    const { data, error } = await q;
    if (error){ errEl.textContent = error.message; return; }
    const list = filterLocal(data||[]);
    if (!list.length){ empty.classList.remove("hidden"); updateKpis([]); return; }

    // Pintar filas
    for (const r of list){
      const t = tabs[current].row(r).map(v=>`<td class="py-2 pr-4 border-b border-slate-100 align-top">${esc(v??"")}</td>`).join("");
      rows.insertAdjacentHTML("beforeend", `<tr>${t}</tr>`);
    }

    // KPIs contables
    if (current==="contable"){ updateKpis(list); }
  }

  function updateKpis(list){
    if (current!=="contable"){ return; }
    let ing=0, egr=0;
    for(const r of list){
      if (r.tipo==="Ingreso") ing += Number(r.monto||0);
      if (r.tipo==="Egreso")  egr += Number(r.monto||0);
    }
    document.getElementById('k_ing').textContent   = formatMoney(ing);
    document.getElementById('k_egr').textContent   = formatMoney(egr);
    document.getElementById('k_saldo').textContent = formatMoney(ing - egr);
  }

  function openModal(){
    document.getElementById("modalTitle").textContent = `Nuevo — ${capitalize(current)}`;
    form.innerHTML = ""; hint.innerHTML = "";
    for (const f of tabs[current].fields){ form.insertAdjacentHTML("beforeend", fieldHTML(f)); }

    if (current==="contable"){ hint.innerHTML = 'Subí una imagen de comprobante (bucket <code>tickets</code> en Storage).'; }
    if (current==="parte"){
      hint.innerHTML = 'Se sugieren actividades del día en "Agenda (texto)". Al guardar se abre WhatsApp con el mensaje.';
      prefillAgendaToday(); // ====> autocompleta con agenda del día
      // Prefija fecha de hoy
      const today = new Date().toISOString().slice(0,10);
      const el = document.getElementById("f_fecha"); if (el) el.value = today;
    }
    modal.classList.remove("hidden");
  }

  async function prefillAgendaToday(){
    const start = new Date(); start.setHours(0,0,0,0);
    const end   = new Date(); end.setHours(23,59,59,999);
    const { data, error } = await sb
      .from('agenda_dom')
      .select('asignado_a,cliente,servicio,hora,estado')
      .gte('fecha', start.toISOString().slice(0,10))
      .lte('fecha', end.toISOString().slice(0,10))
      .order('hora',{ascending:true});
    if (error) return;
    const group = {Amalia:[], Valentino:[], Otros:[]};
    for(const r of (data||[])){ (group[r.asignado_a]||group.Otros).push(r); }
    const fmt = (arr) => arr.map(x => `• ${x.hora||'--:--'} ${x.cliente} — ${x.servicio} (${x.estado||'Pendiente'})`).join('\n') || '—';
    const text = [
      'AMALIA', fmt(group.Amalia), '',
      'VALENTINO', fmt(group.Valentino), '',
      'OTROS', fmt(group.Otros)
    ].join('\n');
    const ta = document.getElementById('f_agenda_texto');
    if (ta) ta.value = text;
  }

  function fieldHTML(f){
    const base = `class="w-full px-3 py-2 rounded-lg bg-white border border-slate-300 outline-none focus:ring focus:ring-amber-300"`;
    if (f.t==="select")
      return `<div><label class="block text-xs mb-1 text-slate-600">${f.l}${f.r?" *":""}</label>
        <select id="f_${f.k}" ${base}>${(f.p||[]).map(x=>`<option>${x}</option>`).join("")}</select></div>`;
    if (f.t==="textarea")
      return `<div class="md:col-span-2"><label class="block text-xs mb-1 text-slate-600">${f.l}${f.r?" *":""}</label>
        <textarea id="f_${f.k}" rows="3" ${base}></textarea></div>`;
    if (f.t==="array")
      return `<div class="md:col-span-2"><label class="block text-xs mb-1 text-slate-600">${f.l}</label>
        <input id="f_${f.k}" placeholder="Ej: Paz, Pianelli, Narváez" ${base}></div>`;
    if (f.t==="json")
      return `<div class="md:col-span-2"><label class="block text-xs mb-1 text-slate-600">${f.l}</label>
        <textarea id="f_${f.k}" rows="3" placeholder='{"clave":"valor"}' ${base}></textarea></div>`;
    if (f.t==="file")
      return `<div class="md:col-span-2"><label class="block text-xs mb-1 text-slate-600">${f.l}</label>
        <input id="f_${f.k}" type="file" ${base}></div>`;
    return `<div><label class="block text-xs mb-1 text-slate-600">${f.l}${f.r?" *":""}</label>
      <input id="f_${f.k}" type="${f.t||'text'}" ${base}></div>`;
  }

  async function save(ev){
    ev?.preventDefault?.();
    const { data: u } = await sb.auth.getUser();
    const uid = u?.user?.id;
    if (!uid){ alert("Sesión expirada"); return; }

    const def = tabs[current];
    let payload = { user_id: uid };

    // Campos
    for (const f of def.fields){
      if (f.t==="file") continue;
      const el = document.getElementById(`f_${f.k}`);
      let v = el ? el.value : null;
      if (f.t==="number" && v!=="") v = Number(v);
      if (f.t==="array"  && v) v = v.split(",").map(x=>x.trim()).filter(Boolean);
      if (f.t==="json"   && v){ try{ v = JSON.parse(v); } catch(e){ alert(`JSON inválido en "${f.l}"`); return; } }
      if (f.r && (v===null || v==="")){ alert(`Completá: ${f.l}`); return; }
      if (v==="") v = null;
      payload[f.k] = v;
    }

    // Upload comprobante (Contable)
    if (current==="contable"){
      const fileInput = document.getElementById("f_file");
      if (fileInput && fileInput.files.length){
        const file = fileInput.files[0];
        const path = `${uid}/${Date.now()}_${file.name}`;
        const up = await sb.storage.from("tickets").upload(path, file, { upsert: false });
        if (up.error){ alert("Upload: " + up.error.message); return; }
        const { data: pub } = sb.storage.from("tickets").getPublicUrl(path);
        payload.url = pub?.publicUrl || null;
      }
    }

    const { data: inserted, error } = await sb.from(def.table).insert(payload).select('id');
    if (error){ alert("Guardar: " + error.message); return; }
    modal.classList.add("hidden");

    // Si es Parte Diario → abrir WhatsApp con mensaje (vista parte_diario_whatsapp)
    if (current==="parte" && inserted?.[0]?.id){ await openWhatsApp(inserted[0].id); }

    await load();
  }

  async function openWhatsApp(parteId){
    const { data, error } = await sb
      .from('parte_diario_whatsapp')
      .select('mensaje')
      .eq('id', parteId)
      .single();
    if (error){ alert("WhatsApp: " + error.message); return; }
    const url = `https://wa.me/${WHATSAPP_PHONE}?text=${encodeURIComponent(data.mensaje || '')}`;
    window.open(url, '_blank');
  }

  // === Exportar PDF del listado visible ===
  function exportPDF(){
    const titleMap = {accesos:"Accesos", paqueteria:"Paquetería", contable:"Contable", agenda:"Agenda", parte:"Parte Diario"};
    const head = [...document.querySelectorAll('#thead th')].map(th => th.textContent.trim());
    const body = [...document.querySelectorAll('#rows tr')].map(tr => [...tr.children].map(td => td.innerText));
    if (!body.length){ alert("No hay datos para exportar."); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
    const title = `CRM San Isidro — ${titleMap[current]}`;
    doc.setFontSize(14); doc.text(title, 40, 40);

    doc.autoTable({
      startY: 60,
      head: [head],
      body,
      styles: { fontSize: 9, cellPadding: 4 },
      headStyles: { fillColor: [245, 158, 11] }, // dorado
      theme: 'striped'
    });

    // Filtros visibles en pie
    const desde = document.getElementById("fDesde").value || "—";
    const hasta = document.getElementById("fHasta").value || "—";
    const q = document.getElementById("q").value || "—";
    let footer = `Rango: ${desde} → ${hasta} | Búsqueda: ${q}`;
    if (current==="agenda" && selAsignado.value !== "Todos") footer += ` | Asignado: ${selAsignado.value}`;
    doc.setFontSize(9); doc.text(footer, 40, doc.lastAutoTable.finalY + 20);

    doc.save(`${titleMap[current]}_${new Date().toISOString().slice(0,10)}.pdf`);
  }

  // helpers
  function esc(v){ return (""+v).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  function formatMoney(n){ const x = Number(n||0); return x.toLocaleString("es-AR",{style:"currency",currency:"ARS"}); }
  function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
</script>
</body>
</html>
