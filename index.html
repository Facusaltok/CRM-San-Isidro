<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CRM San Isidro ‚Äî Acceso</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Anti-cache headers for initial load -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    :root{
      --bg:#0b1220;         /* fondo oscuro elegante */
      --panel:#0f172a;      /* slate-900 */
      --card:#111827;       /* gray-900 */
      --muted:#94a3b8;      /* slate-400 */
      --text:#e5e7eb;       /* gray-200 */
      --gold:#C7A961;
      --line:#1f2937;
      --ring:0 10px 30px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 600px at -10% -10%, rgba(199,169,97,.10), transparent 60%),
        radial-gradient(1200px 600px at 110% 110%, rgba(199,169,97,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .wrap{min-height:100%; display:grid; place-items:center; padding:24px}
    .card{
      background:linear-gradient(180deg, rgba(17,24,39,.85), rgba(17,24,39,.92));
      border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--ring);
      width:min(460px, 96vw); overflow:hidden;
    }
    .header{padding:24px 24px 0; display:flex; align-items:center; gap:12px}
    .logo{width:28px;height:28px;color:var(--gold)}
    .title{font-weight:800; font-size:20px}
    .subtitle{color:var(--muted); font-size:13px}
    .body{padding:24px}
    .field{margin-bottom:14px}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    .input{
      width:100%; height:44px; padding:0 12px; border-radius:12px;
      border:1px solid #263241; background:#0b1220; color:#e5e7eb;
      outline:none; box-shadow:none;
    }
    .input:focus{border-color:#39475c; box-shadow:0 0 0 3px rgba(199,169,97,.18)}
    .row{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:8px}
    .muted{color:var(--muted); font-size:12px}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      height:44px; padding:0 14px; border-radius:12px; border:0; cursor:pointer;
      font-weight:700; letter-spacing:.2px;
    }
    .btn.gold{background:var(--gold); color:#111827}
    .btn.ghost{background:transparent; border:1px solid #263241; color:#e5e7eb}
    .actions{display:flex; gap:10px; margin-top:12px}
    .error{background:#2b1a1a; border:1px solid #6b2a2a; color:#fca5a5; padding:10px 12px; border-radius:12px; font-size:13px; display:none}
    .ok{background:#11271c; border:1px solid #1f7a41; color:#86efac; padding:10px 12px; border-radius:12px; font-size:13px; display:none}
    .pw-wrap{position:relative}
    .pw-toggle{position:absolute; right:10px; top:50%; transform:translateY(-50%); background:transparent; border:0; color:#cbd5e1; cursor:pointer}
    .footer{padding:0 24px 20px; display:flex; align-items:center; justify-content:center}
    .spinner{width:16px;height:16px;border-radius:50%; border:2px solid #111827; border-top-color:#0b1220; border-right-color:#0b1220; margin-left:8px; border-left-color:#111827;
             animation:spin 0.9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    a{color:var(--gold); text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <svg class="logo" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12h18"/><path d="M12 3v18"/>
        </svg>
        <div>
          <div class="title">CRM San Isidro</div>
          <div class="subtitle">Acceso seguro</div>
        </div>
      </div>
      <div class="body">
        <div id="msgError" class="error"></div>
        <div id="msgOk" class="ok"></div>

        <div class="field">
          <label for="email">Correo</label>
          <input id="email" type="email" class="input" placeholder="tu@email.com" autocomplete="email" required>
        </div>

        <div class="field pw-wrap">
          <label for="password">Contrase√±a</label>
          <input id="password" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required>
          <button id="togglePw" class="pw-toggle" title="Mostrar/Ocultar">üëÅÔ∏è</button>
        </div>

        <div class="row">
          <label class="muted"><input id="remember" type="checkbox" checked> Mantener sesi√≥n</label>
          <a class="muted" href="#" id="recoverLink">¬øOlvidaste tu contrase√±a?</a>
        </div>

        <div class="actions">
          <button id="loginBtn" class="btn gold" style="flex:1">Ingresar <span id="spin" class="spinner" style="display:none"></span></button>
          <button id="toDash" class="btn ghost" style="min-width:140px">Ir al Dashboard</button>
        </div>
      </div>
      <div class="footer muted">¬© Monaco Detailing ‚Äî San Isidro</div>
    </div>
  </div>

<script>
  // ========= Anti-cache: remover Service Workers + limpiar caches y redirigir con versi√≥n =========
  async function nukeCaches(){
    try{
      if ('serviceWorker' in navigator){
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r=>r.unregister()));
      }
      if (window.caches){
        const keys = await caches.keys();
        await Promise.all(keys.map(k=>caches.delete(k)));
      }
      console.log('Caches y SW limpiados');
    }catch(e){ console.warn('No se pudo limpiar SW/caches', e); }
  }
  const VERSION = 'v2025-09-20-pro';

  // ========= Supabase =========
  const SUPABASE_URL = window.SUPABASE_URL || "https://YOUR-PROJECT.supabase.co";
  const SUPABASE_KEY = window.SUPABASE_KEY || "YOUR-ANON-KEY";
  const sb = window.sb || supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const emailEl = document.getElementById('email');
  const passEl  = document.getElementById('password');
  const msgErr  = document.getElementById('msgError');
  const msgOk   = document.getElementById('msgOk');
  const loginBtn= document.getElementById('loginBtn');
  const spin    = document.getElementById('spin');
  const togglePw= document.getElementById('togglePw');
  const toDash  = document.getElementById('toDash');
  const remember= document.getElementById('remember');
  const recover = document.getElementById('recoverLink');

  function showError(text){ msgOk.style.display='none'; msgErr.textContent=text; msgErr.style.display='block'; }
  function showOk(text){ msgErr.style.display='none'; msgOk.textContent=text; msgOk.style.display='block'; }
  function clearMsgs(){ msgErr.style.display='none'; msgOk.style.display='none'; }

  togglePw.addEventListener('click', (e)=>{
    e.preventDefault();
    passEl.type = passEl.type === 'password' ? 'text' : 'password';
  });

  recover.addEventListener('click', async (e)=>{
    e.preventDefault();
    clearMsgs();
    if(!emailEl.value){ showError('Ingres√° tu correo para enviarte el enlace de recuperaci√≥n.'); return; }
    try{
      const { error } = await sb.auth.resetPasswordForEmail(emailEl.value, { redirectTo: location.origin + '/dashboard.html?v='+VERSION });
      if (error) throw error;
      showOk('Te enviamos un correo con instrucciones para restablecer tu contrase√±a.');
    }catch(err){ showError(err.message || 'No se pudo iniciar la recuperaci√≥n.'); }
  });

  async function goDashboard(){
    await nukeCaches();
    const url = new URL(location.origin + '/dashboard.html');
    url.searchParams.set('v', VERSION);
    location.href = url.toString();
  }
  toDash.addEventListener('click', (e)=>{ e.preventDefault(); goDashboard(); });

  loginBtn.addEventListener('click', async ()=>{
    clearMsgs();
    const email = emailEl.value.trim();
    const pass  = passEl.value;
    if(!email || !pass){ showError('Complet√° correo y contrase√±a.'); return; }
    loginBtn.disabled=true; spin.style.display='inline-block';
    try{
      // Opcional: persistencia de sesi√≥n
      await sb.auth.setSession(null);
      const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
      if (error) throw error;
      // Mantener sesi√≥n: supabase ya persiste en localStorage. Pod√©s forzar "remember" guardando un flag propio si quer√©s.
      showOk('Ingreso correcto, redirigiendo‚Ä¶');
      await goDashboard();
    }catch(err){
      showError(err.message || 'No se pudo iniciar sesi√≥n.');
    }finally{
      loginBtn.disabled=false; spin.style.display='none';
    }
  });

  // Autologin si ya hay sesi√≥n
  (async function(){
    try{
      const { data } = await sb.auth.getSession();
      if (data?.session){ await goDashboard(); }
    }catch{ /* ignore */ }
  })();
</script>
</body>
</html>
